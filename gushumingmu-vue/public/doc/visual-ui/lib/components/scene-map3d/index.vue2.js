"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const a=require("vue"),i=require("lodash"),B=require("gsap"),D=require("@vueuse/core"),M=require("./map3d/map.js"),W=require("./watch.js");require("three");require("d3-geo");require("three/examples/jsm/controls/OrbitControls");require("three/examples/jsm/loaders/GLTFLoader");require("three/examples/jsm/loaders/DRACOLoader.js");const T=require("./map3d/mini3d/utils/CreateHistory.js");require("three/examples/jsm/libs/lil-gui.module.min");require("three/examples/jsm/utils/BufferGeometryUtils");require("three/examples/jsm/renderers/CSS3DRenderer");const R=require("../../commons/plugins/datasource/index.js"),g=require("../../commons/utils/json2css.js"),c=require("../../commons/plugins/event/index.js"),V={class:"value"},N=["onClick"],j={key:3,class:"fps"},$=a.defineComponent({name:"zv-scene-map3d"}),_=a.defineComponent({...$,props:{basicOption:{},sources:{},useEvents:{},uuid:{}},emits:["on-loaded","on-animated","on-drill-down","on-area-mouseover","on-area-mouseout","on-area-click","on-bar-click","on-scatter-click","on-flyline-click","on-return","on-data-change"],setup(O,{expose:H,emit:q}){const l=O,u=q;c.SHJParseEvent.parseEvents(l.useEvents,"on-page-loaded",null);const n=a.ref(),h=a.ref(!1),b=a.ref(!1),m="zerov-map3d-scene",S="zerov-map3d-scene-wrap",r=new T.createHistory,v=a.ref(!1),y=(e=!0)=>{n.value.cleanAllBar(),n.value.cleanAllScatter(),n.value.cleanAllFlyLine(),n.value.createAllRegionalLevel(),l.sources&&l.sources.length>0&&R.SHJDatasourceV2.parse({tId:l.uuid,sources:l.sources,callback:o=>{try{const t=l.basicOption.widgets&&l.basicOption.widgets.find(p=>p._sourceId===o.id);t&&t.type==="bar"&&n.value.createBar(t,o.data[0].data,!0,e),t&&t.type==="scatter"&&n.value.createScatter(t,o.data[0].data,!0,e),t&&t.type==="flyline"&&n.value.createFlyLine(t,o.data[0].data,!0,e),t&&t.type==="regionalLevel"&&n.value.createRegionalLevel(t,o.data[0].data,!0,e),e&&(n.value.createBarTimeLine(),n.value.createScatterTimeLine(),n.value.createFlyLineTimeLine(),n.value.createRegionalLevelTimeLine()),u("on-data-change",o),c.SHJParseEvent.parseEvents(l.useEvents,"on-data-change",o)}catch{u("on-data-change",null),c.SHJParseEvent.parseEvents(l.useEvents,"on-data-change",null)}}})},L=()=>{document.getElementById(m)&&document.getElementById(S).removeChild(document.getElementById(m));const e=document.createElement("canvas");e.id=m,e.className="zerov-map-3d",e.style.width="100%",e.style.height="100%",document.getElementById(S).appendChild(e)},f=e=>(h.value=!1,b.value=!1,n.value&&(n.value.destroy(),n.value=null),L(),new M.World(document.getElementById(m),{geoProjectionCenter:[108.55,36.32]},e,{onAreaMouseover:t=>{u("on-area-mouseover",t),c.SHJParseEvent.parseEvents(l.useEvents,"on-area-mouseover",t)},onAreaMouseout:t=>{u("on-area-mouseout",t),c.SHJParseEvent.parseEvents(l.useEvents,"on-area-mouseout",t)},onLoadChild:t=>{if(u("on-area-click",t),c.SHJParseEvent.parseEvents(l.useEvents,"on-area-click",t),t.adcode!==r.present&&l.basicOption.scene.isDrilling&&l.basicOption.scene.defaultMapAdcode!==1){u("on-drill-down",t),c.SHJParseEvent.parseEvents(l.useEvents,"on-drill-down",t);const p=i.cloneDeep(l.basicOption);p.scene.defaultMapAdcode=t.adcode,n.value=f(p),r.push(t.adcode),r.past.length<=0?v.value=!1:v.value=!0}},onMapSuccess:()=>{h.value=!0,u("on-loaded"),c.SHJParseEvent.parseEvents(l.useEvents,"on-loaded",null)},onMapAnimationSuccess:()=>{y(),b.value=!0,u("on-animated"),c.SHJParseEvent.parseEvents(l.useEvents,"on-animated",null)},onClickBar:t=>{u("on-bar-click",t),c.SHJParseEvent.parseEvents(l.useEvents,"on-bar-click",t)},onClickScatter:t=>{u("on-scatter-click",t),c.SHJParseEvent.parseEvents(l.useEvents,"on-scatter-click",t)},onClickFlyline:t=>{u("on-flyline-click",t),c.SHJParseEvent.parseEvents(l.useEvents,"on-flyline-click",t)}}));a.onMounted(()=>{setTimeout(()=>{n.value=f(l.basicOption),r.push(l.basicOption.scene.defaultMapAdcode),W.initWatch(l,n,f,y,I)},0)}),a.onBeforeUnmount(()=>{n.value&&n.value.destroy()});const E=()=>{u("on-return",{parentAdcode:r.past[r.past.length-1],adcode:r.present}),c.SHJParseEvent.parseEvents(l.useEvents,"on-return",{parentAdcode:r.past[r.past.length-1],adcode:r.present}),r.undo();const e=i.cloneDeep(l.basicOption);e.scene.defaultMapAdcode=r.present,n.value=f(e),r.past.length<=0?v.value=!1:v.value=!0},I=()=>{r.empty(),r.push(l.basicOption.scene.defaultMapAdcode),n.value=f(l.basicOption),r.past.length<=0?v.value=!1:v.value=!0},P=(e,o,t)=>{B.timeline().add(B.to(n.value.camera.instance.position,{duration:2,delay:0,x:e,y:o,z:t,ease:"circ.out"}))};H({refresh:()=>y(),refreshView:()=>y(),refreshData:()=>y(),goBack:()=>E(),setCameraPosition:(e,o,t)=>P(e,o,t)});const z=D.useFps(),k=a.ref(),F=e=>{if(k.value&&e){g.autoInstallFont(l.basicOption.backButtonCss.fontFamily);const o=`url(${e.backgroundImage})`;return{...g.jsonToCssStyle(e),left:l.basicOption.backButtonLeft+"%",bottom:l.basicOption.backButtonBottom+"%","background-image":o}}return{}},d=a.ref(i.cloneDeep(l.basicOption.widgets)),s=a.computed(()=>{try{const e=d.value.filter(o=>o.type==="regionalLevel");return e.length>0?(g.autoInstallFont(e[0].labelStyle.fontFamily),e[0].isHide?null:e[0]):null}catch{return null}});a.watch(()=>i.cloneDeep(l.basicOption.widgets),(e,o)=>{try{!i.isEqual(e,o)&&n.value&&(d.value=i.cloneDeep(l.basicOption.widgets))}catch{}},{deep:!0}),a.watch(()=>i.cloneDeep(d.value.filter(e=>e.type==="bar")),(e,o)=>{try{!i.isEqual(e,o)&&n.value&&e.length===o.length&&e.forEach(t=>{n.value.createBar(t,void 0,!1)})}catch{}},{deep:!0}),a.watch(()=>i.cloneDeep(d.value.filter(e=>e.type==="scatter")),(e,o)=>{try{!i.isEqual(e,o)&&n.value&&e.length===o.length&&e.forEach(t=>{n.value.createScatter(t,void 0,!1)})}catch{}},{deep:!0}),a.watch(()=>i.cloneDeep(d.value.filter(e=>e.type==="flyline")),(e,o)=>{try{!i.isEqual(e,o)&&n.value&&e.length===o.length&&e.forEach(t=>{n.value.createFlyLine(t,void 0,!1)})}catch{}},{deep:!0}),a.watch(()=>i.cloneDeep(d.value.filter(e=>e.type==="regionalLevel")),(e,o)=>{try{!i.isEqual(e,o)&&n.value&&e.length===o.length&&e.forEach(t=>{n.value.createRegionalLevel(t,void 0,!1)})}catch{}},{deep:!0});const J=e=>{try{e.isHide===void 0?e.isHide=!0:e.isHide=!e.isHide}catch{}},A=()=>{try{const e=d.value.every(o=>!o.isHide);d.value.forEach(o=>o.isHide=e)}catch{}},w=e=>{g.autoInstallFont(l.basicOption.widgetControlStyle.fontFamily);const o=`url(${e.backgroundImage})`,t=`url(${C(e.hover.backgroundImage)})`,p=`url(${C(e.active.backgroundImage)})`;return{...g.jsonToCssStyle(e),...g.jsonToCssStyle(e.hover,"hover"),...g.jsonToCssStyle(e.active,"active"),"background-image":o,"--hover-background-image":t,"--active-background-image":p}},C=e=>!e.startsWith("http")&&!e.startsWith("//")?"../"+e:e;return(e,o)=>(a.openBlock(),a.createElementBlock("div",{id:"zerov-map3d-scene-wrap",class:a.normalizeClass(["map-3d-wrap",{show:h.value}])},[b.value&&v.value&&e.basicOption.backButton?(a.openBlock(),a.createElementBlock("div",{key:0,ref_key:"buttonRef",ref:k,class:"return-btn",style:a.normalizeStyle(F(e.basicOption.backButtonCss)),onClick:E}," 返回上一级 ",4)):a.createCommentVNode("",!0),s.value?(a.openBlock(),a.createElementBlock("div",{key:1,class:"regional-level",style:a.normalizeStyle({left:s.value.labelStyle.left+"%",top:s.value.labelStyle.top+"%",flexDirection:s.value.labelStyle.direction,gap:s.value.labelStyle.gap+"px",fontSize:s.value.labelStyle.fontSize+"px",fontFamily:s.value.labelStyle.fontFamily,fontStyle:s.value.labelStyle.fontStyle,color:s.value.labelStyle.color,"--color-width":s.value.labelStyle.colorStyle.width+"px","--color-height":s.value.labelStyle.colorStyle.height+"px","--color-borderRadius":s.value.labelStyle.colorStyle.borderRadius+"px"})},[(a.openBlock(!0),a.createElementBlock(a.Fragment,null,a.renderList(s.value.rules,(t,p)=>(a.openBlock(),a.createElementBlock("div",{key:p,class:"item"},[a.createElementVNode("div",{class:"color",style:a.normalizeStyle({backgroundColor:t.color})},null,4),a.createElementVNode("span",V,a.toDisplayString(t.label),1)]))),128))],4)):a.createCommentVNode("",!0),e.basicOption.widgets.length>0&&e.basicOption.widgetControlStyle&&e.basicOption.widgetControlStyle.show?(a.openBlock(),a.createElementBlock("div",{key:2,class:"widget-control",style:a.normalizeStyle({left:e.basicOption.widgetControlStyle.left+"%",top:e.basicOption.widgetControlStyle.top+"%",flexDirection:e.basicOption.widgetControlStyle.direction,gap:e.basicOption.widgetControlStyle.gap+"px","--widget-width":e.basicOption.widgetControlStyle.width+"px","--widget-height":e.basicOption.widgetControlStyle.height+"px"})},[a.createElementVNode("div",{class:a.normalizeClass(["control-button",{active:d.value.every(t=>!t.isHide)}]),style:a.normalizeStyle(w(e.basicOption.widgetControlStyle)),onClick:A},a.toDisplayString(d.value.every(t=>!t.isHide)?"隐藏":"显示")+"/全部 ",7),(a.openBlock(!0),a.createElementBlock(a.Fragment,null,a.renderList(d.value,t=>(a.openBlock(),a.createElementBlock("div",{key:t.id,class:a.normalizeClass(["control-button",{active:!t.isHide}]),style:a.normalizeStyle(w(e.basicOption.widgetControlStyle)),onClick:p=>J(t)},a.toDisplayString(t.name||"-"),15,N))),128))],4)):a.createCommentVNode("",!0),e.basicOption.debugger?(a.openBlock(),a.createElementBlock("div",j," fps:"+a.toDisplayString(a.unref(z)),1)):a.createCommentVNode("",!0)],2))}});exports.default=_;
