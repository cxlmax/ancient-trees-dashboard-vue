"use strict";var F=Object.defineProperty;var j=(S,w,e)=>w in S?F(S,w,{enumerable:!0,configurable:!0,writable:!0,value:e}):S[w]=e;var n=(S,w,e)=>j(S,typeof w!="symbol"?w+"":w,e);Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const s=require("three"),D=require("three-mesh-bvh"),q=require("pinyin-pro"),R=require("./mini3d/core/index.js");require("three/examples/jsm/loaders/GLTFLoader");require("three/examples/jsm/loaders/DRACOLoader.js");const T=require("./mini3d/utils/utils.js");require("three/examples/jsm/libs/lil-gui.module.min");require("three/examples/jsm/utils/BufferGeometryUtils");const C=require("./mini3d/components/Label3d.js"),I=require("./mini3d/components/FlyLine.js"),z=require("./mini3d/components/ToastLoading.js"),P=require("./mini3d/components/PathLine.js"),O=require("./map/assets.js"),H=require("./map/extrudeMap.js"),f=require("gsap"),v=require("lodash"),A=require("../../../commons/utils/json2css.js"),N=require("./module/FloorGaoGuang.js"),E=require("./module/FloorRotateBorder.js"),W=require("./module/FloorGridRipple.js"),Q=require("./module/MapMirror.js"),$=require("./module/Timeline.js"),U=require("./module/Particles.js"),B=require("./map/utils.js"),V=require("./module/Environment.js");s.BufferGeometry.prototype.computeBoundsTree=D.computeBoundsTree;s.BufferGeometry.prototype.disposeBoundsTree=D.disposeBoundsTree;s.Mesh.prototype.raycast=D.acceleratedRaycast;s.Sprite.prototype.raycast=D.acceleratedRaycast;class X extends R.Mini3d{constructor(e,t,a,o){super(e,t,a);n(this,"pointCenter");n(this,"depth");n(this,"toastLoading");n(this,"sceneGroup");n(this,"assets");n(this,"mainSceneGroup");n(this,"childSceneGroup");n(this,"allAreaLabel");n(this,"areaLabelGroup");n(this,"label3d");n(this,"rotateBorder1");n(this,"rotateBorder2");n(this,"mapBoxHelper");n(this,"quan");n(this,"areaMapGroup");n(this,"provinceMesh");n(this,"provinceLineMaterial");n(this,"areaMapTopMaterial");n(this,"areaMapSideMaterial");n(this,"childMap");n(this,"groundMirror");n(this,"particles");n(this,"barGroup");n(this,"barGuangQuanGroup");n(this,"allBar");n(this,"allBarMaterial");n(this,"allBarGuangquan");n(this,"allBarLabel");n(this,"allScatterLabel");n(this,"barLabelGroup");n(this,"scatterLabelGroup");n(this,"pathLine");n(this,"pathLineTexture");n(this,"gaoguangMesh");n(this,"gridRippleGroup");n(this,"diffuseShader");n(this,"scale",1);n(this,"datasource",{});n(this,"flyLineGroup");n(this,"allFlyLine");n(this,"hoverAreaMap");n(this,"raycasterMousemove");n(this,"clientRect");n(this,"mouse");n(this,"isMousedown");n(this,"isMapAnimationSuccess");n(this,"mapBackgroundImgMesh");n(this,"mapBackgroundImgMaterial");n(this,"mapJsonData");n(this,"allRegionalLevel");n(this,"axesHelper");this.option=a,this.onCallBack=o,this.pointCenter=t.geoProjectionCenter,this.depth=this.option.map.depth,this.option.scene.isBackground!==!1&&(this.scene.background=new s.Color(this.option.scene.background||"#000000")),this.camera.instance.position.set(this.option.camera.position.x+(a.scene.translateX||0),this.option.camera.position.y+(a.scene.translateY||0)+200,this.option.camera.position.z+(a.scene.translateZ||0)),this.camera.instance.near=1,this.camera.instance.far=1e4,this.camera.instance.updateProjectionMatrix(),this.option.camera.target&&this.camera.controls.target.set(this.option.camera.target[0]+(a.scene.translateX||0),this.option.camera.target[1]+(a.scene.translateY||0),this.option.camera.target[2]+(a.scene.translateZ||0)),this.hoverAreaMap=null,this.clickMapObj=null,this.axesHelper=new s.AxesHelper(100),this.axesHelper.visible=this.option.debugger,this.scene.add(this.axesHelper),this.raycasterMousemove=new s.Raycaster,this.clientRect=this.renderer.instance.domElement.getBoundingClientRect(),this.mouse=new s.Vector2,this.isMousedown=!1,this.isMapAnimationSuccess=!1,V.createEnvironment(this,this.option.light,this.option.debugger),this.toastLoading=new z.ToastLoading,this.assets=new O.Assets(()=>{this.mapBoxHelper=null,this.sceneGroup=new s.Group,this.mainSceneGroup=new s.Group,this.childSceneGroup=new s.Group,this.mapTitleLabel=null,this.mapTitleLableGroup=new s.Group,this.areaMapGroup=new s.Group,this.allAreaLabel=[],this.areaLabelGroup=new s.Group,this.allBar=[],this.allBarLabel=[],this.allBarMaterial=[],this.allBarGuangquan=[],this.barGroup=new s.Group,this.barLabelGroup=new s.Group,this.barGuangQuanGroup=new s.Group,this.allScatterLabel=[],this.scatterLabelGroup=new s.Group,this.flyLineGroup=new s.Group,this.flyLineLabelGroup=new s.Group,this.allFlyLine=[],this.allFlyLineLabel=[],this.allRegionalLevel=[],this.label3d=new C.Label3d(this),this.mainSceneGroup.rotateX(-Math.PI/2),this.mainSceneGroup.add(this.areaLabelGroup,this.areaMapGroup,this.mapTitleLableGroup),this.sceneGroup.add(this.mainSceneGroup,this.childSceneGroup),this.scene.add(this.sceneGroup),this.createAreaMapModel(()=>{this.createAreaMapStorke(this.option.map.storkeAnimation,!0).then(()=>{this.time.on("tick",i=>{this.pathLineTexture&&(this.pathLineTexture.offset.x+=this.option.map.storkeAnimation.speed*i)}),U.createParticles(this,this.option.particle),N.createFloorGaoGuang(this,this.option.floor.gaoguang,this.option.floor.quan),E.createFloorRotateBorder(this,this.option.floor.rotateBorder),W.createFloorGridRipple(this,this.option.floor.gridRipple),this.time.on("tick",i=>{this.diffuseShader.pointShader&&(this.diffuseShader.pointShader.uniforms.uTime.value+=i,this.diffuseShader.pointShader.uniforms.uTime.value>600/this.option.floor.gridRipple.diffuseSpeed&&(this.diffuseShader.pointShader.uniforms.uTime.value=0))}),this.createMapBackgroundImg(),this.canvas.addEventListener("mousemove",this.handleHoverAreaMap.bind(this),!1),this.canvas.addEventListener("mousedown",this.handleMapMousedown.bind(this),!1),this.canvas.addEventListener("mouseup",this.handleMapMouseup.bind(this),!1);try{this.onCallBack.onMapSuccess()}catch{}$.createTimeLine(this,this.option)})})},{topMap:this.option.map.topMaterial.map,topNormal:this.option.map.topMaterial.normalMap,sideMap:this.option.map.sideMaterial.map,pathLine:this.option.map.storkeAnimation.texture,gridRippleMap:this.option.floor.gridRipple.map,gridRippleAlphaMap:this.option.floor.gridRipple.alphaMap,rotateBorder1Map:this.option.floor.rotateBorder.rotateBorder1.map,rotateBorder2Map:this.option.floor.rotateBorder.rotateBorder2.map})}createMapBackgroundImg(e=!0){try{const t=this.scene.getObjectByName("MapBackgroundImgMesh");if(t&&this.scene.remove(t),this.option.map.backgroundImg&&this.option.map.backgroundImg.show){const{src:a,alphaMap:o,color:i,opacity:r,rotation:l,position:p,scale:c}=this.option.map.backgroundImg,h=new s.PlaneGeometry(500,500),u=new s.TextureLoader().load(a);u.encoding=s.sRGBEncoding;const d=a?{map:u}:{},m=new s.TextureLoader().load(o),M=o?{alphaMap:m}:{};this.mapBackgroundImgMaterial=new s.MeshBasicMaterial({...d,...M,color:i,transparent:!0,opacity:e?0:r,side:s.DoubleSide}),u.wrapS=u.wrapT=s.RepeatWrapping,this.mapBackgroundImgMesh=new s.Mesh(h,this.mapBackgroundImgMaterial),this.mapBackgroundImgMesh.rotation.x=l[0]*(Math.PI/180),this.mapBackgroundImgMesh.rotation.y=l[1]*(Math.PI/180),this.mapBackgroundImgMesh.rotation.z=l[2]*(Math.PI/180),this.mapBackgroundImgMesh.position.x=p[0],this.mapBackgroundImgMesh.position.y=p[1],this.mapBackgroundImgMesh.position.z=p[2],this.mapBackgroundImgMesh.scale.x=c[0],this.mapBackgroundImgMesh.scale.y=c[1],this.mapBackgroundImgMesh.scale.z=c[2],this.mapBackgroundImgMesh.name="MapBackgroundImgMesh",this.scene.add(this.mapBackgroundImgMesh)}}catch{}}createAreaMapModel(e){this.createArea(t=>{this.provinceMesh=t,this.createMapTitleLabel(this.mapTitleLableGroup),t.setParent(this.areaMapGroup),this.areaMapGroup.position.set(0,0,-5),this.areaMapGroup.scale.set(1,1,0),this.areaMapGroup.visible=!1,this.createAreaLabel(this.areaData,this.areaLabelGroup),Q.createMirror(this),e(!0)})}createArea(e){const t=a=>{this.mapJsonData=a,this.provinceLineMaterial=new s.LineBasicMaterial({color:new s.Color(this.option.map.lineColor||"#000000"),transparent:!0});let[o,i]=this.createProvinceMaterial(this.option.map.topMaterial,this.option.map.sideMaterial);this.areaMapTopMaterial=o,this.areaMapSideMaterial=i;let r=new H.ExtrudeMap(this,{center:this.pointCenter,position:new s.Vector3(0,0,.06),data:a,depth:this.depth,topFaceMaterial:this.areaMapTopMaterial,sideMaterial:this.areaMapSideMaterial,lineMaterial:this.provinceLineMaterial,renderOrder:9});this.option.scene.defaultMapAdcode!==1e5&&B.setScaleArea(this,r),this.areaData=r.coordinates,this.time.on("tick",()=>{i.map&&(i.map.offset.y+=.002)});const l=T.getBoundBox(r.mapGroup);this.mapBoxHelper=new s.Box3Helper(l.box3,new s.Color("#ffffff")),this.mapBoxHelper.rotation.x=Math.PI/2,this.mapBoxHelper.visible=this.option.debugger,this.mapBoxHelper.name="mapBoxHelper",this.scene.add(this.mapBoxHelper),r.mapGroup.children.map((p,c)=>{p.children.map(h=>{h.type==="Mesh"&&B.calcUv2(h.geometry,l.boxSize.x,l.boxSize.y,l.box3.min.x,l.box3.min.y)})}),e&&e(r)};this.option.scene.defaultMapAdcode&&this.option.scene.defaultMapAdcode!==1&&B.getMapDataByAdcode(this.option.scene.defaultMapAdcode,a=>t(a)),this.option.scene.defaultMapAdcode&&this.option.scene.defaultMapAdcode===1&&this.option.scene.geojson&&B.getMapDataByUrl(this.option.scene.geojson,a=>t(a))}createAreaMapStorke(e,t=!0){return new Promise((a,o)=>{if(this.option.scene.defaultMapAdcode===1){a(!0);return}try{const i=this.mainSceneGroup.getObjectByName("PathLine");i&&this.mainSceneGroup.remove(i);let r=B.getTextureResource(this,"pathLine",e.texture,"texture");if(v.isEmpty(r))a(!0);else{let l=r.texture;l.wrapS=l.wrapT=s.RepeatWrapping,l.repeat.set(1,1),this.pathLineTexture=l,B.getMapDataByAdcode2(this.option.scene.defaultMapAdcode,p=>{try{if(p){p=JSON.parse(p);let c=p.features.map(d=>({geometry:d.geometry})),h=new P.PathLine(this,{data:c,texture:l,renderOrder:21,speed:e.speed,radius:e.radius/this.scale,segments:e.segments||2560,radialSegments:4,material:new s.MeshBasicMaterial({color:new s.Color(e.color||"#2bc4dc"),map:l,alphaMap:l,fog:!1,transparent:!0,opacity:t?0:1,blending:s.AdditiveBlending})});h.instance.name="PathLine";const u=this.mainSceneGroup.getObjectByName("PathLine");if(u&&this.mainSceneGroup.remove(u),h.setParent(this.mainSceneGroup),this.boundBox){h.instance.scale.set(this.scale,this.scale,this.scale);const d=this.boundBox;h.instance.position.x=-d.center.x,h.instance.position.y=-d.center.y}h.instance.position.z=this.depth+.38+(e.top||0),this.pathLine=h}}catch{}finally{a(!0)}})}}catch{a(!0)}})}createAreaLabel(e,t){const a=(o,i,r)=>{let l=this.label3d.create("","area-label",!0);return l.init(`<p class="label">${o.name}</p>`,r),this.label3d.setLabelStyle(l,.08/this.scale,"x"),l.setParent(t),l.userData.adcode=o.adcode,l.userData.position=[r.x,r.y,r.z],l};e.map((o,i)=>{if(o.name&&o.centroid&&o.adcode){let[r,l]=this.geoProjection(o.centroid),p=a(o,i,new s.Vector3(r,-l,this.depth+2));this.allAreaLabel.push(p)}}),this.option.scene.defaultMapAdcode!==1e5&&this.setAreaLabelScale(),this.setAreaLabelStyle(this.option.map.arealabel)}createMapTitleLabel(e){if(this.option.scene.defaultMapAdcode!==1e5&&this.option.scene.defaultMapAdcode!==1){let t=T.getBoundBox(this.provinceMesh.mapGroup);const a=this.option.map.titleLabel&&this.option.map.titleLabel.gaodeAPI||"",o=`https://restapi.amap.com/v3/config/district?keywords=${this.option.scene.defaultMapAdcode}&subdistrict=0&key=${a}`;fetch(o).then(i=>i.text()).then(i=>{try{const r=JSON.parse(i);if(r.status==="1"&&r.districts.length>0){const l=this.option.map.titleLabel&&this.option.map.titleLabel.offsetX||0,p=this.option.map.titleLabel&&this.option.map.titleLabel.offsetY||2,c=d=>{let m=this.label3d.create("","map-label",!1);return m.init(`<div class="other-label"><span class="title">${d.name}</span><span>${d.enName}</span></div>`,new s.Vector3(t.center.x/this.scale+l,(t.center.y-t.boxSize.y/2-p)/this.scale,.4)),this.label3d.setLabelStyle(m,.115/this.scale,"x"),m.setParent(e),m},h=q.pinyin(r.districts[0].name.slice(0,-1),{toneType:"none",separator:""}).toUpperCase();this.mapTitleLabel=c({name:r.districts[0].name,enName:h+" "+r.districts[0].level.toUpperCase()}),this.mapTitleLableGroup.scale.set(this.scale,this.scale,this.scale);let u=(this.depth+.4)/this.scale;this.mapTitleLabel.position.z=u,this.mapTitleLabel.position.y-=1.5/this.scale,this.setMapTitleLabelStyle(this.option.map.titleLabel)}}catch{}}).catch(i=>{})}}setMapTitleLabelStyle(e){if(e){A.autoInstallFont(e.fontFamily);const t=this.mapTitleLabel.element.querySelector(".map-label>.other-label");e.show?t.style.opacity=1:t.style.opacity=0,t.style.fontSize=e.fontSize+"px",t.style.fontFamily=e.fontFamily,t.style.color=e.color}else this.mapTitleLabel.element.style.opacity=0}setAreaLabelScale(){this.areaLabelGroup.scale.set(this.scale,this.scale,this.scale);const e=this.boundBox;this.areaLabelGroup.position.x=-e.center.x,this.areaLabelGroup.position.y=-e.center.y,this.allAreaLabel.map(t=>{let a=(this.depth+.4)/this.scale;t.position.z=a,t.position.y-=1.5/this.scale,t.userData.position=[t.position.x,t.position.y,t.position.z]})}setAreaLabelStyle(e){e&&(A.autoInstallFont(e.fontFamily),this.allAreaLabel.map((t,a)=>{const o=t.element.querySelector(".area-label>p.label");e.show?o.style.opacity=1:o.style.opacity=0,o.style.fontSize=e.fontSize+"px",o.style.fontFamily=e.fontFamily,o.style.color=e.color}))}setAreaLabelMove(e,t="up"){this.allAreaLabel.map(a=>{if(a.userData.adcode===e){const o=a.userData.position[2]+(this.depth/2+.3)/this.scale,i=a.userData.position[2];f.to(a.position,{duration:.3,z:t==="up"?o:i})}})}createProvinceMaterial(e,t){let a=B.getTextureResource(this,"topMap",e.map,"map"),o=B.getTextureResource(this,"topNormal",e.normalMap,"normalMap"),i=new s.MeshStandardMaterial({...a,...o,color:new s.Color(e.color||"#061e47"),emissive:new s.Color(e.emissive||"#000000"),transparent:!0,opacity:e.opacity}),r=B.getTextureResource(this,"sideMap",t.map,"map");v.isEmpty(r)||(r.map.repeat.set(1,.2),r.map.offset.y+=.01);let l=new s.MeshStandardMaterial({...r,color:new s.Color(t.color||"#061e47"),transparent:!0,opacity:t.opacity,side:s.DoubleSide});return[i,l]}createBar(e,t,a=!0,o=!1){if(!(!a&&(t=this.datasource[e._sourceId],!t))&&(a||(this.barGroup.remove(...this.barGroup.children.filter(i=>i.name==="bar-"+e.id)),this.barGuangQuanGroup.remove(...this.barGuangQuanGroup.children.filter(i=>i.name==="bar-"+e.id)),this.barLabelGroup.remove(...this.barLabelGroup.children.filter(i=>i.name==="bar-"+e.id)),this.allBar=this.allBar.filter(i=>i.name!=="bar-"+e.id),this.allBarLabel=this.allBarLabel.filter(i=>i.name!=="bar-"+e.id),this.allBarMaterial=this.allBarMaterial.filter(i=>i.name!=="bar-"+e.id),this.allBarGuangquan=this.allBarGuangquan.filter(i=>i.name!=="bar-"+e.id)),t&&v.isArray(t)&&t.length>0))try{if(this.datasource[e._sourceId]=t,!e.isHide){const i=(c,h,u)=>{let d=e.format;try{const M=e.format.match(/\{(.*?)}/g);if(M)for(let y=0;y<M.length;y++)d=d.replaceAll(M[y],c[M[y].slice(1,-1)])}catch{}let m=this.label3d.create("","bar-label bar-"+e.id,!0);return m.init(`
            <div class="wrap">
              <span class="label">${d}</span>
              <span class="unit">${e.label.unit||""}</span>
            </div>
          `,u),this.label3d.setLabelStyle(m,.08/this.scale,"x"),m.name="bar-"+e.id,m.setParent(this.barLabelGroup),m.userData.adcode=c.adcode,m.userData.value=c.value,m.userData.name=c.name,m.userData.position=[u.x,u.y,u.z],m},r=e.width||7,l=e.height||7,p=Math.max.apply(Math,t.map(c=>c.value));t.map((c,h)=>{if(v.isNumber(c.value)){let u=c.value<=0?.1:l*(c.value/p),d=new s.MeshBasicMaterial({color:new s.Color(e.color||"#ffffff"),transparent:!0,opacity:o?0:e.opacity,depthTest:!1,fog:!1});d.name="bar-"+e.id,d.userData.opacity=e.opacity;const m=new s.BoxGeometry(.05*r,.05*r,u);m.translate(0,0,u/2);const M=new s.Mesh(m,d);M.renderOrder=22,M.geometry.computeBoundsTree();let y=M,[G,x]=this.geoProjection(c.coords);y.position.set(G,-x,(this.depth+.46)/this.scale),o?y.scale.set(1/this.scale,1/this.scale,0):y.scale.set(1/this.scale,1/this.scale,1/this.scale),y.userData.name=c.name,y.userData.adcode=c.adcode,y.userData.value=c.value,y.userData.position=[G,-x,(this.depth+.46)/this.scale];let L=this.createBarGuangQuan(e.bottom,o);if(L.position.set(G,-x,(this.depth+.46)/this.scale),L.userData.name=c.name,L.userData.adcode=c.adcode,L.userData.position=[G,-x,(this.depth+.46)/this.scale],L.name="bar-"+e.id,this.barGuangQuanGroup.add(L),e.huiguang.show&&u>0){let b=this.createBarHUIGUANG(u,e.huiguang);y.add(...b)}y.name="bar-"+e.id,this.barGroup.add(y);let g=i(c,h,new s.Vector3(G,-x,(this.depth+.9+u)/this.scale));this.allBar.push(y),this.allBarMaterial.push(d),this.allBarGuangquan.push(L),this.allBarLabel.push(g)}}),this.setBarLabelStyle(e.label,e.id),this.barGroup.scale.set(this.scale,this.scale,this.scale),this.barGuangQuanGroup.scale.set(this.scale,this.scale,this.scale),this.barLabelGroup.scale.set(this.scale,this.scale,this.scale),this.mainSceneGroup.add(this.barGroup),this.mainSceneGroup.add(this.barGuangQuanGroup),this.mainSceneGroup.add(this.barLabelGroup),this.option.scene.defaultMapAdcode!==1e5&&this.setBarScale()}}catch{}}cleanAllBar(){for(;this.barGroup.children.length;)this.barGroup.remove(this.barGroup.children[0]);for(;this.barGuangQuanGroup.children.length;)this.barGuangQuanGroup.remove(this.barGuangQuanGroup.children[0]);for(;this.barLabelGroup.children.length;)this.barLabelGroup.remove(this.barLabelGroup.children[0]);this.allBar=[],this.allBarLabel=[],this.allBarMaterial=[],this.allBarGuangquan=[]}createBarTimeLine(){const e=f.timeline();this.allBar.map((t,a)=>{e.add(f.to(t.scale,{duration:1,delay:.05*a,x:1/this.scale,y:1/this.scale,z:1/this.scale,ease:"circ.out"}),"bar")}),this.allBarMaterial.map((t,a)=>{e.add(f.to(t,{duration:.5,delay:.05*a,opacity:t.userData.opacity,ease:"circ.out"}),"bar")}),this.allBarGuangquan.map((t,a)=>{e.add(f.to(t.children[0].scale,{duration:.5,delay:.05*a,x:1/this.scale,y:1/this.scale,z:1/this.scale,ease:"circ.out"}),"bar"),e.add(f.to(t.children[1].scale,{duration:.5,delay:.05*a,x:1/this.scale,y:1/this.scale,z:1/this.scale,ease:"circ.out"}),"bar")}),this.allBarLabel.map(t=>{const a=t.element.querySelector(".bar-label .wrap");a.style.opacity=0}),this.allBarLabel.map((t,a)=>{const o=t.element.querySelector(".bar-label .label"),i=t.element.querySelector(".bar-label .wrap"),r=Number(o.innerText),l={score:0};if(e.add(f.to(o,{duration:.5,delay:.05*a,opacity:1,ease:"circ.out"}),"bar"),e.add(f.to(i,{duration:.5,delay:.05*a,opacity:1,ease:"circ.out"}),"bar"),r){let p=function(){o.innerText=l.score.toFixed(0)};const c=f.to(l,{duration:2,delay:.05*a,score:r,onUpdate:p});e.add(c,"bar")}})}setBarLabelStyle(e,t){e&&(A.autoInstallFont(e.fontFamily),A.autoInstallFont(e.unitStyle.fontFamily),this.allBarLabel.map((a,o)=>{if(a.name==="bar-"+t){const i=a.element.querySelector(".bar-label.bar-"+t+" .wrap");e.show?i.style.opacity=1:i.style.opacity=0,i&&(i.style.backgroundColor=e.bg.color,i.style.padding=`${e.bg.paddingW}px ${e.bg.paddingH}px`,i.style.borderRadius=e.bg.borderRadius+"px",i.style.borderWidth=e.bg.borderWidth+"px",i.style.borderColor=e.bg.borderColor,i.style.borderStyle=e.bg.borderStyle);const r=a.element.querySelector(".bar-label.bar-"+t+" .label");e.show?r.innerText=r.innerText:r.innerText="",r.style.fontSize=e.fontSize+"px",r.style.fontFamily=e.fontFamily,r.style.color=e.color;const l=a.element.querySelector(".bar-label.bar-"+t+" .unit");e.show&&e.unitStyle.show?l.innerText=l.innerText:l.innerText="",l.style.fontSize=e.unitStyle.fontSize+"px",l.style.fontFamily=e.unitStyle.fontFamily,l.style.color=e.unitStyle.color}}))}setBarScale(){const e=this.boundBox;this.barGroup.position.x=-e.center.x,this.barGroup.position.y=-e.center.y,this.barGuangQuanGroup.position.x=-e.center.x,this.barGuangQuanGroup.position.y=-e.center.y,this.barLabelGroup.position.x=-e.center.x,this.barLabelGroup.position.y=-e.center.y}createBarHUIGUANG(e,t){let a=new s.PlaneGeometry(t.size,e);a.translate(0,e/2,0);const o=this.assets.instance.getResource("huiguang");o.colorSpace="srgb",o.wrapS=s.RepeatWrapping,o.wrapT=s.RepeatWrapping;let i=new s.MeshBasicMaterial({color:new s.Color(t.color||"#ffffff"),map:o,transparent:!0,opacity:t.opacity,depthWrite:!1,side:s.DoubleSide,blending:s.AdditiveBlending}),r=new s.Mesh(a,i);r.renderOrder=23,r.rotateX(Math.PI/2);let l=r.clone(),p=r.clone();return l.rotateY(Math.PI/180*60),p.rotateY(Math.PI/180*120),[r,l,p]}createBarGuangQuan(e,t){const a=this.assets.instance.getResource("guangquan1"),o=this.assets.instance.getResource("guangquan2");let i=new s.PlaneGeometry(e.width,e.height),r=new s.MeshBasicMaterial({color:new s.Color(e.color||"#ffffff"),map:a,alphaMap:a,opacity:e.opacity,transparent:!0,depthTest:!1,fog:!1,blending:s.AdditiveBlending}),l=new s.MeshBasicMaterial({color:new s.Color(e.color||"#ffffff"),map:o,alphaMap:o,opacity:e.opacity,transparent:!0,depthTest:!1,fog:!1,blending:s.AdditiveBlending}),p=new s.Mesh(i,r),c=new s.Mesh(i,l);p.renderOrder=24,c.renderOrder=24,c.position.z-=.001,t?(p.scale.set(0,0,0),c.scale.set(0,0,0)):(p.scale.set(1/this.scale,1/this.scale,1/this.scale),c.scale.set(1/this.scale,1/this.scale,1/this.scale));const h=new s.Group;return h.add(p,c),this.time.on("tick",u=>{p.rotation.z+=u*2}),h}setBarMove(e,t="up"){this.allBar.map(a=>{a.userData.adcode===e&&f.to(a.position,{duration:.3,z:t==="up"?a.userData.position[2]+this.depth/2+.3:a.userData.position[2]})})}setBarGuangQuanMove(e,t="up"){this.allBarGuangquan.map(a=>{a.userData.adcode===e&&f.to(a.position,{duration:.3,z:t==="up"?a.userData.position[2]+this.depth/2+.3:a.userData.position[2]})})}setBarLabelMove(e,t="up"){this.allBarLabel.map(a=>{a.userData.adcode===e&&f.to(a.position,{duration:.3,z:t==="up"?a.userData.position[2]+this.depth/2+.3:a.userData.position[2]})})}createScatter(e,t=[],a=!0,o=!1){if(!(!a&&(t=this.datasource[e._sourceId],!t))&&(a||(this.scatterLabelGroup.remove(...this.scatterLabelGroup.children.filter(i=>i.name==="scatter-"+e.id)),this.allScatterLabel=this.allScatterLabel.filter(i=>i.name!=="scatter-"+e.id)),t&&v.isArray(t)&&t.length>0))try{if(this.datasource[e._sourceId]=t,!e.isHide){const i=(r,l,p)=>{let c=e.format;try{const u=e.format.match(/\{(.*?)}/g);if(u)for(let d=0;d<u.length;d++)c=c.replaceAll(u[d],r[u[d].slice(1,-1)])}catch{}let h=this.label3d.create("","scatter-label scatter-"+e.id,e.follow);return h.init(`<div class="wrap">
                <span class="label">${c}</span>
                <img src="${e.map}" style="width:${e.width}px; height:${e.height}px;" >
              </div>`,p),this.label3d.setLabelStyle(h,.08/this.scale,"x"),e.rotation&&(h.rotation.x=e.rotation[0]*(Math.PI/180),h.rotation.y=e.rotation[1]*(Math.PI/180),h.rotation.z=e.rotation[2]*(Math.PI/180)),h.name="scatter-"+e.id,h.setParent(this.scatterLabelGroup),h.userData.adcode=r.adcode,h.userData.scale=r,h.userData.name=r.name,h.userData.labelShow=e.label.show,h.userData.value=r.value,h.userData.position=[p.x,p.y,p.z],h};t.map((r,l)=>{let[p,c]=this.geoProjection([r.lng,r.lat]),h=i(r,l,new s.Vector3(p,-c,this.depth/this.scale));this.allScatterLabel.push(h)}),this.setScatterLabelStyle(e.label,e.id),this.mainSceneGroup.add(this.scatterLabelGroup),this.scatterLabelGroup.scale.set(this.scale,this.scale,this.scale),this.option.scene.defaultMapAdcode!==1e5&&this.setScatterScale()}}catch{}}setScatterLabelStyle(e,t){e&&(A.autoInstallFont(e.fontFamily),this.allScatterLabel.map((a,o)=>{if(a.name==="scatter-"+t){const i=a.element.querySelector(".scatter-label.scatter-"+t+" .wrap");e.show?i.style.opacity=1:i.style.opacity=0;const r=a.element.querySelector(".scatter-label.scatter-"+t+" .label");e.show?r.innerText=r.innerText:r.innerText="",r.style.left=e.left+"px",r.style.top=e.top+"px",r.style.fontSize=e.fontSize+"px",r.style.fontFamily=e.fontFamily,r.style.color=e.color,r.style.backgroundColor=e.bg.color,r.style.padding=`${e.bg.paddingW}px ${e.bg.paddingH}px`,r.style.borderRadius=e.bg.borderRadius+"px",r.style.borderWidth=e.bg.borderWidth+"px",r.style.borderColor=e.bg.borderColor,r.style.borderStyle=e.bg.borderStyle}}))}setScatterScale(){const e=this.boundBox;this.scatterLabelGroup.position.x=-e.center.x,this.scatterLabelGroup.position.y=-e.center.y}createScatterTimeLine(){const e=f.timeline();this.allScatterLabel.map(t=>{const a=t.element.querySelector(".scatter-label .wrap");a.style.opacity=0}),this.allScatterLabel.map((t,a)=>{if(t.userData.labelShow){const o=t.element.querySelector(".scatter-label .wrap");e.add(f.to(o,{duration:.5,delay:.05*a,opacity:1,ease:"circ.out"}),"scatter")}})}cleanAllScatter(){for(;this.scatterLabelGroup.children.length;)this.scatterLabelGroup.remove(this.scatterLabelGroup.children[0]);this.allScatterLabel=[]}setScatterLabelMove(e,t="up"){this.allScatterLabel.map(a=>{a.userData.adcode===e&&f.to(a.position,{duration:.3,z:t==="up"?a.userData.position[2]+this.depth/2+.3:a.userData.position[2]})})}createFlyLine(e,t,a=!0,o=!1){if(!(!a&&(t=this.datasource[e._sourceId],!t))&&(a||(this.flyLineGroup.remove(...this.flyLineGroup.children.filter(i=>i.name==="flyline-"+e.id)),this.flyLineLabelGroup.remove(...this.flyLineLabelGroup.children.filter(i=>i.name==="flyline-"+e.id)),this.allFlyLine=this.allFlyLine.filter(i=>i.name!=="flyline-"+e.id),this.allFlyLineLabel=this.allFlyLineLabel.filter(i=>i.name!=="flyline-"+e.id)),t&&v.isArray(t)&&t.length>0))try{if(this.datasource[e._sourceId]=t,!e.isHide){const i=new s.TextureLoader().load(e.texture);i.wrapS=i.wrapT=s.RepeatWrapping,i.generateMipmaps=!1,i.magFilter=s.NearestFilter,i.repeat.set(.5,1);let r=new I.FlyLine(this,{data:t,option:e,texture:i,radius:e.radius/this.scale,speed:e.speed,middleHeight:e.middleHeight/this.scale,segments:e.segments,radialSegments:e.radialSegments,allFlyLine:this.allFlyLine,material:new s.MeshBasicMaterial({map:i,alphaMap:i,color:new s.Color(e.material.color),transparent:!0,opacity:o?0:e.material.opacity,fog:!1,depthTest:!1,blending:s.AdditiveBlending})});r.instance.name="flyline-"+e.id,r.instance.position.z=(this.depth+.4)/this.scale,this.flyLineGroup.add(r.instance),this.setFlylineLabelStyle(e.label,e.id),this.flyLineGroup.scale.set(this.scale,this.scale,this.scale),this.flyLineLabelGroup.scale.set(this.scale,this.scale,this.scale),this.mainSceneGroup.add(this.flyLineGroup),this.mainSceneGroup.add(this.flyLineLabelGroup),this.option.scene.defaultMapAdcode!==1e5&&this.setFlylineScale()}}catch{}}setFlylineLabelStyle(e,t){e&&(A.autoInstallFont(e.fontFamily),this.allFlyLineLabel.map((a,o)=>{if(a.name==="flyline-"+t){const i=a.element.querySelector(".flyline-label.flyline-"+t+" .wrap");e.show?i.style.opacity=1:i.style.opacity=0,i&&(i.style.backgroundColor=e.bg.color,i.style.padding=`${e.bg.paddingW}px ${e.bg.paddingH}px`,i.style.borderRadius=e.bg.borderRadius+"px",i.style.borderWidth=e.bg.borderWidth+"px",i.style.borderColor=e.bg.borderColor,i.style.borderStyle=e.bg.borderStyle);const r=a.element.querySelector(".flyline-label.flyline-"+t+" .label");e.show?r.innerText=r.innerText:r.innerText="",r.style.fontSize=e.fontSize+"px",r.style.fontFamily=e.fontFamily,r.style.color=e.color}}))}setFlylineScale(){const e=this.boundBox;this.flyLineGroup.position.x=-e.center.x,this.flyLineGroup.position.y=-e.center.y,this.flyLineLabelGroup.position.x=-e.center.x,this.flyLineLabelGroup.position.y=-e.center.y}cleanAllFlyLine(){for(;this.flyLineGroup.children.length;)this.flyLineGroup.remove(this.flyLineGroup.children[0]);for(;this.flyLineLabelGroup.children.length;)this.flyLineLabelGroup.remove(this.flyLineLabelGroup.children[0]);this.allFlyLine=[],this.allFlyLineLabel=[]}createFlyLineTimeLine(){const e=f.timeline();this.allFlyLine.map((t,a)=>{e.add(f.to(t.material,{duration:.2,opacity:1,ease:"circ.out"}),"flyLine")}),this.allFlyLineLabel.map(t=>{const a=t.element.querySelector(".flyline-label .wrap");a.style.opacity=0}),this.allFlyLineLabel.map((t,a)=>{const o=t.element.querySelector(".flyline-label .wrap");e.add(f.to(o,{duration:.5,delay:.05*a,opacity:1,ease:"circ.out"}),"flyline")})}createRegionalLevel(e,t,a=!0,o=!1){try{if(!a&&(t=this.datasource[e._sourceId],!t))return;a||this.areaMapGroup.children[0].children.forEach(i=>{i.remove(...i.children.filter(r=>r.name==="shapeGroup-"+e.id))}),t&&v.isArray(t)&&t.length>0&&(this.datasource[e._sourceId]=t,e.isHide||T.transfromMapGeoJSON(this.mapJsonData).features.forEach((r,l)=>{const{name:p,adcode:c,parent:h}=r.properties,u=new s.Group;u.name="shapeGroup-"+e.id,r.geometry.coordinates.forEach(m=>{m.forEach((M,y)=>{const G=new s.Shape;for(let g=0;g<M.length;g++){if(!M[g][0]||!M[g][1])return!1;const[b,k]=this.geoProjection(M[g]);g===0&&G.moveTo(b,-k),G.lineTo(b,-k)}const x=t.find(g=>g.name===p);let L=e.defaultColor;if(x)for(let g=0;g<e.rules.length;g++){const b=e.rules[g];x.value>=b.min&&x.value<=b.max&&(L=b.color||e.defaultColor)}try{const g=new s.ShapeGeometry(v.cloneDeep(G)),b=new s.Mesh(g,new s.MeshStandardMaterial({color:new s.Color(L),transparent:!0,opacity:o?0:e.opacity}));b.userData.depth=this.depth,b.userData.name=p,b.userData.adcode=c,b.userData.parent=h,b.userData.opacity=e.opacity,b.renderOrder=20,b.name="shapeArea",this.allRegionalLevel.push(b),u.add(b)}catch{}})}),u.position.set(0,0,this.depth+.2);const d=this.areaMapGroup.getObjectByName("meshGroup"+l);if(d&&d.children.length>1){const m=this.areaMapGroup.getObjectByName("meshGroup"+l);m&&m.add(u)}}))}catch{}}createAllRegionalLevel(){this.areaMapGroup.children[0].children.forEach(e=>{e.remove(...e.children.filter(t=>t.name.includes("shapeGroup-")))})}createRegionalLevelTimeLine(){const e=f.timeline();this.allRegionalLevel.map((t,a)=>{e.add(f.to(t.material,{duration:.5,delay:.002*a,opacity:t.userData.opacity,ease:"circ.out"}),"RegionalLevel")})}handleMapMousedown(e){if(e.preventDefault(),this.isMousedown=!0,!this.isMapAnimationSuccess)return;const t=new s.Raycaster,a=new s.Vector2,o=this.renderer.instance.domElement.getBoundingClientRect();a.x=(e.clientX-o.left)/o.width*2-1,a.y=-((e.clientY-o.top)/o.height)*2+1,t.setFromCamera(a,this.camera.instance);let i=t.intersectObjects(this.scene.children,!0);i=i.filter(r=>r.object.name.includes("scatter-")||r.object.name.includes("bar-")||r.object.name.includes("flyline-")||r.object.name.includes("mapArea-")),i.length>0&&i[0]?this.clickMapObj=i[0]:this.clickMapObj=null}handleMapMouseup(e){if(e.preventDefault(),this.isMousedown=!1,!!this.isMapAnimationSuccess&&this.clickMapObj){if(this.clickMapObj.object.name.includes("scatter-")&&this.clickMapObj.object.visible&&this.onCallBack.onClickScatter(this.clickMapObj.object.userData),this.clickMapObj.object.name.includes("bar-")&&this.clickMapObj.object.visible&&this.onCallBack.onClickBar(this.clickMapObj.object.userData),this.clickMapObj.object.name.includes("flyline-")&&this.clickMapObj.object.visible&&this.onCallBack.onClickFlyline(this.clickMapObj.object.userData),this.clickMapObj.object.name.includes("mapArea-")){let t=this.clickMapObj.object.userData;this.onCallBack.onLoadChild(t)}this.clickMapObj=null}}handleHoverAreaMap(e){if(e.preventDefault(),this.clickMapObj=null,!this.isMapAnimationSuccess)return;if(this.isMousedown){this.hoverAreaMap&&this.reset(this.hoverAreaMap.parent);return}this.mouse.x=(e.clientX-this.clientRect.left)/this.clientRect.width*2-1,this.mouse.y=-((e.clientY-this.clientRect.top)/this.clientRect.height)*2+1,this.raycasterMousemove.setFromCamera(this.mouse,this.camera.instance);let t=this.raycasterMousemove.intersectObjects(this.areaMapGroup.children,!0);if(t=t.filter(a=>a.object.name.includes("mapArea-")),t.length>0&&t[0]&&t[0].object.name.includes("mapArea-")){if(this.hoverAreaMap===null){this.move(t[0].object.parent,t[0].object);return}this.hoverAreaMap.name!==t[0].object.name&&(this.reset(this.hoverAreaMap.parent),this.move(t[0].object.parent,t[0].object))}else this.hoverAreaMap&&this.reset(this.hoverAreaMap.parent)}move(e,t){try{const a=this.areaMapTopMaterial.clone();a.opacity=this.option.map.topMaterial.hoverOpacity||1,e.children[0].material[0]=a;const o=e.getObjectByName("lineGroup");if(o&&o.children&&o.children[0]){const i=this.provinceLineMaterial.clone();i.color=new s.Color(this.option.map.hoverLineColor||this.option.map.lineColor||"#000000"),o.children[0].material=i}}catch{}f.to(e.scale,{duration:.3,z:this.option.map.hoverDepth||1.5}),this.setAreaLabelMove(e.userData.adcode),this.setBarMove(e.userData.adcode),this.setBarGuangQuanMove(e.userData.adcode),this.setBarLabelMove(e.userData.adcode),this.setScatterLabelMove(e.userData.adcode),this.onCallBack.onAreaMouseover(t.userData),this.hoverAreaMap=t}reset(e){try{e.children[0].material[0]=this.areaMapTopMaterial;const t=e.getObjectByName("lineGroup");t&&t.children&&t.children[0]&&(t.children[0].material=this.provinceLineMaterial)}catch{}f.to(e.scale,{duration:.3,z:1}),this.setAreaLabelMove(e.userData.adcode,"down"),this.setBarMove(e.userData.adcode,"down"),this.setBarGuangQuanMove(e.userData.adcode,"down"),this.setBarLabelMove(e.userData.adcode,"down"),this.setScatterLabelMove(e.userData.adcode,"down"),this.onCallBack.onAreaMouseout(this.hoverAreaMap.userData),this.hoverAreaMap=null}update(){super.update()}destroy(){try{super.destroy(),this.canvas.removeEventListener("mousedown",this.handleMapMousedown.bind(this),!1),this.canvas.removeEventListener("mouseup",this.handleMapMouseup.bind(this),!1),this.canvas.removeEventListener("mousemove",this.handleHoverAreaMap.bind(this),!1),this.label3d&&this.label3d.destroy(),this.groundMirror&&this.groundMirror.dispose(),this.toastLoading&&this.toastLoading.destroy(),this.childMap&&this.childMap.destroy()}catch{}}}exports.World=X;
