"use strict";var x=Object.defineProperty;var B=(d,h,m)=>h in d?x(d,h,{enumerable:!0,configurable:!0,writable:!0,value:m}):d[h]=m;var b=(d,h,m)=>B(d,typeof h!="symbol"?h+"":h,m);Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const n=require("vue");require("@babylonjs/loaders/glTF");const r=require("lodash"),o=require("@babylonjs/core"),T=require("@vueuse/core"),z=require("../../commons/plugins/event/index.js"),M={class:"zerov-widget"},q=n.defineComponent({name:"zv-commons-three-loader"}),I=n.defineComponent({...q,props:{basicOption:{},basicEvents:{},useEvents:{}},emits:["on-load-success","on-play-animation"],setup(d,{expose:h,emit:m}){const L=m,u=d,C=(t,l)=>{const g=n.ref(),P=n.ref(),y=n.ref(!0);class F{constructor(e){b(this,"loadingUIBackgroundColor");this.loadingUIText=e}displayLoadingUI(){g.value&&(y.value=!0)}hideLoadingUI(){g.value&&(y.value=!1)}}class S{constructor(e,s,i){b(this,"scene");b(this,"engine");b(this,"meshe");b(this,"defaultPipeline");this.canvas=e,this.option=s,this.events=i;try{this.engine=new o.Engine(this.canvas,!0,{},!1),this.engine.loadingScreen=new F(""),window.addEventListener("resize",()=>{this.engine.resize()}),this.scene=this.createScene()}catch{}}createScene(){return this.scene=new o.Scene(this.engine),this.option.scene.colorShow?this.scene.clearColor=o.Color4.FromHexString(this.option.scene.color||"#000000"):this.scene.clearColor=new o.Color4(0,0,0,0),this.scene.fogEnabled=this.option.scene.fogEnabled,this.scene.fogMode=this.option.scene.fogMode||1,this.scene.fogColor=o.Color3.FromHexString(this.option.scene.fogColor||"#ffffff"),this.scene.fogEnd=this.option.scene.fogEnd||60,this.scene.fogStart=this.option.scene.fogStart||1,this.scene.fogDensity=this.option.scene.fogDensity||.1,this.createCamera(this.option.camera,this.scene),this.createLights(this.option.lights,this.scene),this.createMeshs(this.scene),this.scene}updateScenePipeline(e){this.scene.activeCamera&&e&&(e.enabled?(this.defaultPipeline||(this.defaultPipeline=new o.DefaultRenderingPipeline("defaultPipeline",!0,this.scene,[this.scene.activeCamera])),this.defaultPipeline.samples=e.samples?4:1,this.defaultPipeline.fxaaEnabled=e.fxaaEnabled,this.defaultPipeline.grainEnabled=e.grainEnabled,this.defaultPipeline.grain.intensity=e.grainIntensity,this.defaultPipeline.grain.animated=e.grainAnimated,this.defaultPipeline.bloomEnabled=e.bloomEnabled,this.defaultPipeline.bloomThreshold=e.bloomThreshold,this.defaultPipeline.bloomWeight=e.bloomWeight,this.defaultPipeline.bloomKernel=e.bloomKernel,this.defaultPipeline.bloomScale=e.bloomScale,this.defaultPipeline.depthOfFieldEnabled=e.depthOfFieldEnabled,e.depthOfFieldBlurLevel<1?this.defaultPipeline.depthOfFieldBlurLevel=o.DepthOfFieldEffectBlurLevel.Low:e.depthOfFieldBlurLevel<2?this.defaultPipeline.depthOfFieldBlurLevel=o.DepthOfFieldEffectBlurLevel.Medium:e.depthOfFieldBlurLevel<3&&(this.defaultPipeline.depthOfFieldBlurLevel=o.DepthOfFieldEffectBlurLevel.High),this.defaultPipeline.depthOfField.focusDistance=e.depthOfFieldFocusDistance,this.defaultPipeline.depthOfField.fStop=e.depthOfFieldFStop,this.defaultPipeline.depthOfField.focalLength=e.depthOfFieldFocalLength,this.defaultPipeline.chromaticAberrationEnabled=e.chromaticAberrationEnabled,this.defaultPipeline.chromaticAberration.aberrationAmount=e.chromaticAberrationAberrationAmount,this.defaultPipeline.chromaticAberration.radialIntensity=e.chromaticAberrationRadialIntensity,e.chromaticAberrationDirection===0?(this.defaultPipeline.chromaticAberration.direction.x=0,this.defaultPipeline.chromaticAberration.direction.y=0):(this.defaultPipeline.chromaticAberration.direction.x=Math.sin(e.chromaticAberrationDirection),this.defaultPipeline.chromaticAberration.direction.y=Math.cos(e.chromaticAberrationDirection)),this.defaultPipeline.sharpenEnabled=e.sharpenEnabled,this.defaultPipeline.sharpen.edgeAmount=e.sharpenEdgeAmount,this.defaultPipeline.sharpen.colorAmount=e.sharpenColorAmount):this.defaultPipeline&&(this.defaultPipeline.dispose(),this.defaultPipeline=null))}updateScene(e){e.colorShow?this.scene.clearColor=o.Color4.FromHexString(e.color||"#000000"):this.scene.clearColor=new o.Color4(0,0,0,0),this.scene.fogEnabled=e.fogEnabled,this.scene.fogMode=e.fogMode||1,this.scene.fogColor=o.Color3.FromHexString(e.fogColor||"#ffffff"),this.scene.fogEnd=e.fogEnd||60,this.scene.fogStart=e.fogStart||1,this.scene.fogDensity=e.fogDensity||.1}createCamera(e,s){const i=new o.ArcRotateCamera("",o.Tools.ToRadians(e.alpha||90),o.Tools.ToRadians(e.beta||75),e.radius||1,new o.Vector3(...e.target),s);i.attachControl(g.value,!0),i.useAutoRotationBehavior=e.autoRotation,i.wheelDeltaPercentage=e.wheelDeltaPercentage||.01,i.zoomToMouseLocation=e.zoomToMouseLocation,i.lowerRadiusLimit=e.lowerRadiusLimit,i.upperRadiusLimit=e.upperRadiusLimit,i.minZ=.01}updateCamera(e){const s=this.scene.activeCamera;s&&(e.radius&&(s.radius=e.radius),s.beta=o.Tools.ToRadians(e.beta),s.alpha=o.Tools.ToRadians(e.alpha),s.useAutoRotationBehavior=e.autoRotation,s.zoomToMouseLocation=e.zoomToMouseLocation,s.wheelDeltaPercentage=e.wheelDeltaPercentage||.01,s.lowerRadiusLimit=e.lowerRadiusLimit,s.upperRadiusLimit=e.upperRadiusLimit,s.target=new o.Vector3(...e.target))}createLights(e,s){this.scene&&this.scene.lights&&this.scene.lights.forEach((i,c)=>{setTimeout(()=>{i.dispose()})}),setTimeout(()=>{e.forEach(i=>{if(i.type==="HemisphericLight"){const c=new o.HemisphericLight("",new o.Vector3(...i.direction),s);c.intensity=i.intensity!==void 0?i.intensity:.5,c.groundColor=o.Color3.FromHexString(i.groundColor||"#ffffff"),c.diffuse=o.Color3.FromHexString(i.diffuse||"#ffffff")}if(i.type==="DirectionalLight"){const c=new o.DirectionalLight("",new o.Vector3(...i.direction),s);c.intensity=i.intensity!==void 0?i.intensity:.5,c.diffuse=o.Color3.FromHexString(i.diffuse||"#ffffff")}if(i.type==="PointLight"){const c=new o.PointLight("",new o.Vector3(...i.position),s);c.intensity=i.intensity!==void 0?i.intensity:.5,c.diffuse=o.Color3.FromHexString(i.diffuse||"#ffffff")}})})}createMeshs(e){e.meshes.forEach(s=>setTimeout(()=>s.dispose())),o.SceneLoader.ImportMeshAsync("",this.option.meshs.url,"",e,s=>{P.value=(s.loaded/s.total*100).toFixed(2)}).then(s=>{this.meshe=s.meshes,this.updateScenePipeline(this.option.pipelineOption),this.option.animationGroups=e.animationGroups.map(i=>({uniqueId:i.uniqueId,name:i.name})),this.events&&(this.events.function[0].args[0].select=e.animationGroups.map(i=>({name:i.name,value:i.name}))),this.option.defaultAnimation&&this.option.defaultAnimation.name?this.playAnimation(this.option.defaultAnimation.name,{loop:this.option.defaultAnimation.loop,speedRatio:this.option.defaultAnimation.speedRatio}):e.animationGroups&&e.animationGroups[0]&&e.animationGroups[0].stop(),this.setMeshSize(this.option.meshs),setTimeout(()=>{this.engine.hideLoadingUI(),L("on-load-success"),this.engine.hideLoadingUI()},100)})}setMeshSize(e){if(e.autoSize){const i=this.meshe[0].getBoundingInfo().boundingBox,p=.7/(Math.max(i.maximumWorld.x-i.minimumWorld.x,i.maximumWorld.y-i.minimumWorld.y,i.maximumWorld.z-i.minimumWorld.z)||1);this.meshe[0].scaling=new o.Vector3(p,p,p);const R=i.centerWorld;this.meshe[0].position=this.meshe[0].position.subtract(R.multiplyByFloats(p,p,p)),this.meshe[0].rotation=new o.Vector3(0,0,0)}else{const{position:s,scaling:i,rotation:c}=e;this.meshe[0].position.set(s[0]||0,s[1]||0,s[2]||0),this.meshe[0].scaling.set(i[0]||1,i[1]||1,i[2]||1),this.meshe[0].rotation=new o.Vector3(c[0]||0,c[1]||0,c[2]||0)}}run(){return this.engine.runRenderLoop(()=>this.scene.render()),this}dispose(){this.scene&&this.engine&&(this.scene.dispose(),this.engine.dispose())}playAnimation(e,s={loop:!1,speedRatio:1}){if(this.scene){this.scene.stopAllAnimations();const i=this.scene.getAnimationGroupByName(e);i&&(L("on-play-animation"),z.SHJParseEvent.parseEvents(u.useEvents,"on-play-animation"),i.start(s.loop,s.speedRatio,i.from,i.to,!1))}}}const f=n.ref();return n.onMounted(()=>{t.meshs&&(f.value=new S(g.value,t,l).run(),T.useResizeObserver(g.value,A=>{f.value&&f.value.engine.resize()}))}),n.onBeforeUnmount(()=>{f.value&&(f.value.dispose(),f.value.meshe=[])}),{canvasRef:g,babylon:f,Babylon:S,babylonLoadingStatus:y,babylonLoadingTitle:P}},{canvasRef:v,babylon:a,Babylon:E,babylonLoadingStatus:w,babylonLoadingTitle:D}=C(u.basicOption,u.basicEvents);return h({playAnimation:(t,l)=>{a.value.playAnimation(t,l)}}),n.watch(()=>r.cloneDeep(u.basicOption.camera),(t,l)=>{!r.isEqual(t,l)&&a.value&&a.value.updateCamera(t)},{deep:!0}),n.watch(()=>r.cloneDeep(u.basicOption.scene),(t,l)=>{!r.isEqual(t,l)&&a.value&&a.value.updateScene(t)},{deep:!0}),n.watch(()=>r.cloneDeep(u.basicOption.lights),(t,l)=>{!r.isEqual(t,l)&&a.value&&a.value.createLights(t,a.value.scene)},{deep:!0}),n.watch(()=>r.cloneDeep(u.basicOption.meshs.url),(t,l)=>{!r.isEqual(t,l)&&a.value&&(a.value.dispose(),a.value=new E(v.value,u.basicOption,u.basicEvents).run())},{deep:!0}),n.watch(()=>r.cloneDeep(u.basicOption.meshs.position),(t,l)=>{!r.isEqual(t,l)&&a.value&&a.value.meshe[0]&&a.value.meshe[0].position.set(t[0],t[1],t[2])},{deep:!0}),n.watch(()=>r.cloneDeep(u.basicOption.meshs.scaling),(t,l)=>{!r.isEqual(t,l)&&a.value&&a.value.meshe[0]&&a.value.meshe[0].scaling.set(t[0],t[1],t[2])},{deep:!0}),n.watch(()=>r.cloneDeep(u.basicOption.meshs.rotation),(t,l)=>{!r.isEqual(t,l)&&a.value&&a.value.meshe[0]&&(a.value.meshe[0].rotation=new o.Vector3(t[0],t[1],t[2]))},{deep:!0}),n.watch(()=>r.cloneDeep(u.basicOption.meshs.autoSize),(t,l)=>{!r.isEqual(t,l)&&a.value&&a.value.meshe[0]&&a.value.setMeshSize(u.basicOption.meshs)},{deep:!0}),n.watch(()=>r.cloneDeep(u.basicOption.defaultAnimation),(t,l)=>{!r.isEqual(t,l)&&a.value&&(a.value.dispose(),a.value=new E(v.value,u.basicOption,u.basicEvents).run())},{deep:!0}),n.watch(()=>r.cloneDeep(u.basicOption.pipelineOption),(t,l)=>{!r.isEqual(t,l)&&a.value&&a.value.updateScenePipeline(t)},{deep:!0}),(t,l)=>(n.openBlock(),n.createElementBlock("div",M,[n.createElementVNode("canvas",{ref_key:"canvasRef",ref:v,class:n.normalizeClass(["widget",{show:!n.unref(w)}])},null,2),n.unref(w)?(n.openBlock(),n.createElementBlock("div",{key:0,ref:"babylonLoadingRef",class:"babylon-loading"}," 正在加载模型...("+n.toDisplayString(n.unref(D))+"%) ",513)):n.createCommentVNode("",!0)]))}});exports.default=I;
