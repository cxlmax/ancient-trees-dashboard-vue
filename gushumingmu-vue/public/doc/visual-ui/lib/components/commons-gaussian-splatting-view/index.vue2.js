"use strict";var E=Object.defineProperty;var z=(u,i,h)=>i in u?E(u,i,{enumerable:!0,configurable:!0,writable:!0,value:h}):u[i]=h;var p=(u,i,h)=>z(u,typeof i!="symbol"?i+"":i,h);Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const o=require("vue");require("@babylonjs/loaders/glTF");const B=require("@vueuse/core"),n=require("@babylonjs/core"),c=require("lodash"),D={class:"zerov-widget"},x={key:0,ref:"babylonLoadingRef",class:"babylon-loading"},T=o.defineComponent({name:"zv-commons-gaussian-splatting-view"}),_=o.defineComponent({...T,props:{basicOption:{},basicEvents:{}},setup(u){const i=u,h=(s,r)=>{const d=o.ref(),b=o.ref(!0);class L{constructor(e){p(this,"loadingUIBackgroundColor");this.loadingUIText=e}displayLoadingUI(){d.value&&(b.value=!0)}hideLoadingUI(){d.value&&(b.value=!1)}}class S{constructor(e,l,t){p(this,"scene");p(this,"engine");p(this,"gs");this.canvas=e,this.option=l,this.events=t;try{this.engine=new n.Engine(this.canvas,!0,{},!1),this.engine.loadingScreen=new L(""),window.addEventListener("resize",()=>{this.engine.resize()}),this.scene=this.createScene()}catch{}}createScene(){return this.engine.displayLoadingUI(),this.scene=new n.Scene(this.engine),this.option.scene.colorShow?this.scene.clearColor=n.Color4.FromHexString(this.option.scene.color||"#000000"):this.scene.clearColor=new n.Color4(0,0,0,0),this.scene.fogEnabled=this.option.scene.fogEnabled,this.scene.fogMode=this.option.scene.fogMode||1,this.scene.fogColor=n.Color3.FromHexString(this.option.scene.fogColor||"#ffffff"),this.scene.fogEnd=this.option.scene.fogEnd||60,this.scene.fogStart=this.option.scene.fogStart||1,this.scene.fogDensity=this.option.scene.fogDensity||.1,this.createCamera(this.option.camera,this.scene),this.gs=new n.GaussianSplattingMesh("",null,this.scene),this.gs.loadFileAsync(this.option.meshs.url).then(()=>{this.setGSSize(this.option.meshs),setTimeout(()=>{this.engine.hideLoadingUI()},100)}),this.scene}setGSSize(e){if(e.autoSize){const t=this.gs.getBoundingInfo().boundingBox,f=.7/(Math.max(t.maximumWorld.x-t.minimumWorld.x,t.maximumWorld.y-t.minimumWorld.y,t.maximumWorld.z-t.minimumWorld.z)||1);this.gs.scaling=new n.Vector3(f,f,f);const R=t.centerWorld;this.gs.position=this.gs.position.subtract(R.multiplyByFloats(f,f,f)),this.gs.rotation=new n.Vector3(0,0,0)}else{const{position:l,scaling:t,rotation:m}=e;this.gs.position.set(l[0]||0,l[1]||0,l[2]||0),this.gs.scaling.set(t[0]||1,t[1]||1,t[2]||1),this.gs.rotation=new n.Vector3(m[0]||0,m[1]||0,m[2]||0)}}updateScene(e){e.colorShow?this.scene.clearColor=n.Color4.FromHexString(e.color||"#000000"):this.scene.clearColor=new n.Color4(0,0,0,0),this.scene.fogEnabled=e.fogEnabled,this.scene.fogMode=e.fogMode||1,this.scene.fogColor=n.Color3.FromHexString(e.fogColor||"#ffffff"),this.scene.fogEnd=e.fogEnd||60,this.scene.fogStart=e.fogStart||1,this.scene.fogDensity=e.fogDensity||.1}createCamera(e,l){const t=new n.ArcRotateCamera("",n.Tools.ToRadians(e.alpha||90),n.Tools.ToRadians(e.beta||75),e.radius||1,new n.Vector3(...e.target),l);t.attachControl(d.value,!0),t.useAutoRotationBehavior=e.autoRotation,t.wheelDeltaPercentage=e.wheelDeltaPercentage||.01,t.zoomToMouseLocation=e.zoomToMouseLocation,t.lowerRadiusLimit=e.lowerRadiusLimit,t.upperRadiusLimit=e.upperRadiusLimit,t.minZ=.01}updateCamera(e){const l=this.scene.activeCamera;l&&(e.radius&&(l.radius=e.radius),l.beta=n.Tools.ToRadians(e.beta),l.alpha=n.Tools.ToRadians(e.alpha),l.useAutoRotationBehavior=e.autoRotation,l.zoomToMouseLocation=e.zoomToMouseLocation,l.wheelDeltaPercentage=e.wheelDeltaPercentage||.01,l.lowerRadiusLimit=e.lowerRadiusLimit,l.upperRadiusLimit=e.upperRadiusLimit,l.target=new n.Vector3(...e.target))}run(){return this.engine.runRenderLoop(()=>{this.scene.render()}),this}dispose(){this.scene&&this.engine&&(this.scene.dispose(),this.engine.dispose(),this.gs.dispose(),this.gs=null)}}const g=o.ref();return o.onMounted(()=>{s.meshs&&(g.value=new S(d.value,s,r).run(),B.useResizeObserver(d.value,C=>{g.value&&g.value.engine.resize()}))}),o.onBeforeUnmount(()=>{g.value&&g.value.dispose()}),{canvasRef:d,babylon:g,Babylon:S,babylonLoadingStatus:b}},{babylon:a,Babylon:y,canvasRef:v,babylonLoadingStatus:w}=h(i.basicOption,i.basicEvents);return o.watch(()=>c.cloneDeep(i.basicOption.scene),(s,r)=>{!c.isEqual(s,r)&&a.value&&a.value.updateScene(s)},{deep:!0}),o.watch(()=>c.cloneDeep(i.basicOption.meshs.url),(s,r)=>{!c.isEqual(s,r)&&a.value&&(a.value.dispose(),a.value=new y(v.value,i.basicOption,i.basicEvents).run())},{deep:!0}),o.watch(()=>c.cloneDeep(i.basicOption.meshs.position),(s,r)=>{!c.isEqual(s,r)&&a.value&&a.value.gs&&a.value.gs.position.set(s[0],s[1],s[2])},{deep:!0}),o.watch(()=>c.cloneDeep(i.basicOption.meshs.scaling),(s,r)=>{!c.isEqual(s,r)&&a.value&&a.value.gs&&a.value.gs.scaling.set(s[0],s[1],s[2])},{deep:!0}),o.watch(()=>c.cloneDeep(i.basicOption.meshs.rotation),(s,r)=>{!c.isEqual(s,r)&&a.value&&a.value.gs&&(a.value.gs.rotation=new n.Vector3(s[0],s[1],s[2]))},{deep:!0}),o.watch(()=>c.cloneDeep(i.basicOption.meshs.autoSize),(s,r)=>{!c.isEqual(s,r)&&a.value&&a.value.gs&&a.value.setGSSize(i.basicOption.meshs)},{deep:!0}),o.watch(()=>c.cloneDeep(i.basicOption.camera),(s,r)=>{!c.isEqual(s,r)&&a.value&&a.value.updateCamera(s)},{deep:!0}),(s,r)=>(o.openBlock(),o.createElementBlock("div",D,[o.createElementVNode("canvas",{ref_key:"canvasRef",ref:v,class:o.normalizeClass(["widget",{show:!o.unref(w)}])},null,2),o.unref(w)?(o.openBlock(),o.createElementBlock("div",x," 正在加载模型... ",512)):o.createCommentVNode("",!0)]))}});exports.default=_;
