"use strict";var F=Object.defineProperty;var B=(f,h,m)=>h in f?F(f,h,{enumerable:!0,configurable:!0,writable:!0,value:m}):f[h]=m;var c=(f,h,m)=>B(f,typeof h!="symbol"?h+"":h,m);Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const i=require("vue");require("@babylonjs/loaders/glTF");const l=require("lodash"),M=require("@vueuse/core"),a=require("@babylonjs/core"),A=require("../../commons/plugins/event/index.js"),R={class:"zerov-widget"},G=i.defineComponent({name:"zv-commons-product-model"}),T=i.defineComponent({...G,props:{basicOption:{},basicEvents:{},useEvents:{}},emits:["on-load-success","on-play-animation"],setup(f,{expose:h,emit:m}){const S=m,r=f,C=(t,n)=>{const g=i.ref(),b=i.ref(),w=i.ref(!0);class D{constructor(e){c(this,"loadingUIBackgroundColor");this.loadingUIText=e}displayLoadingUI(){g.value&&(w.value=!0)}hideLoadingUI(){g.value&&(w.value=!1)}}class E{constructor(e,o,d){c(this,"scene");c(this,"engine");c(this,"environmentHelper");c(this,"shadowsLight");c(this,"shadowGenerator");c(this,"defaultPipeline");this.canvas=e,this.option=o,this.events=d;try{this.engine=new a.Engine(this.canvas,!0,{},!1),this.engine.loadingScreen=new D(""),window.addEventListener("resize",()=>{this.engine.resize()}),this.scene=this.createScene()}catch{}}createScene(){return this.engine.displayLoadingUI(),this.scene=new a.Scene(this.engine),this.option.scene.colorShow?this.scene.clearColor=a.Color4.FromHexString(this.option.scene.color||"#000000"):this.scene.clearColor=new a.Color4(0,0,0,0),this.scene.fogEnabled=this.option.scene.fogEnabled,this.scene.fogMode=this.option.scene.fogMode||1,this.scene.fogColor=a.Color3.FromHexString(this.option.scene.fogColor||"#ffffff"),this.scene.fogEnd=this.option.scene.fogEnd||60,this.scene.fogStart=this.option.scene.fogStart||1,this.scene.fogDensity=this.option.scene.fogDensity||.1,this.scene.createDefaultCamera(!0,!1,!0),this.updateMeshs(this.scene),this.scene}updateScenePipeline(e){this.scene.activeCamera&&e&&(e.enabled?(this.defaultPipeline||(this.defaultPipeline=new a.DefaultRenderingPipeline("defaultPipeline",!0,this.scene,[this.scene.activeCamera])),this.defaultPipeline.samples=e.samples?4:1,this.defaultPipeline.fxaaEnabled=e.fxaaEnabled,this.defaultPipeline.grainEnabled=e.grainEnabled,this.defaultPipeline.grain.intensity=e.grainIntensity,this.defaultPipeline.grain.animated=e.grainAnimated,this.defaultPipeline.bloomEnabled=e.bloomEnabled,this.defaultPipeline.bloomThreshold=e.bloomThreshold,this.defaultPipeline.bloomWeight=e.bloomWeight,this.defaultPipeline.bloomKernel=e.bloomKernel,this.defaultPipeline.bloomScale=e.bloomScale,this.defaultPipeline.depthOfFieldEnabled=e.depthOfFieldEnabled,e.depthOfFieldBlurLevel<1?this.defaultPipeline.depthOfFieldBlurLevel=a.DepthOfFieldEffectBlurLevel.Low:e.depthOfFieldBlurLevel<2?this.defaultPipeline.depthOfFieldBlurLevel=a.DepthOfFieldEffectBlurLevel.Medium:e.depthOfFieldBlurLevel<3&&(this.defaultPipeline.depthOfFieldBlurLevel=a.DepthOfFieldEffectBlurLevel.High),this.defaultPipeline.depthOfField.focusDistance=e.depthOfFieldFocusDistance,this.defaultPipeline.depthOfField.fStop=e.depthOfFieldFStop,this.defaultPipeline.depthOfField.focalLength=e.depthOfFieldFocalLength,this.defaultPipeline.chromaticAberrationEnabled=e.chromaticAberrationEnabled,this.defaultPipeline.chromaticAberration.aberrationAmount=e.chromaticAberrationAberrationAmount,this.defaultPipeline.chromaticAberration.radialIntensity=e.chromaticAberrationRadialIntensity,e.chromaticAberrationDirection===0?(this.defaultPipeline.chromaticAberration.direction.x=0,this.defaultPipeline.chromaticAberration.direction.y=0):(this.defaultPipeline.chromaticAberration.direction.x=Math.sin(e.chromaticAberrationDirection),this.defaultPipeline.chromaticAberration.direction.y=Math.cos(e.chromaticAberrationDirection)),this.defaultPipeline.sharpenEnabled=e.sharpenEnabled,this.defaultPipeline.sharpen.edgeAmount=e.sharpenEdgeAmount,this.defaultPipeline.sharpen.colorAmount=e.sharpenColorAmount):this.defaultPipeline&&(this.defaultPipeline.dispose(),this.defaultPipeline=null))}updateScene(e){e.colorShow?this.scene.clearColor=a.Color4.FromHexString(e.color||"#000000"):this.scene.clearColor=new a.Color4(0,0,0,0),this.scene.fogEnabled=e.fogEnabled,this.scene.fogMode=e.fogMode||1,this.scene.fogColor=a.Color3.FromHexString(e.fogColor||"#ffffff"),this.scene.fogEnd=e.fogEnd||60,this.scene.fogStart=e.fogStart||1,this.scene.fogDensity=e.fogDensity||.1}updateShadowsLight(e){if(e.show){if(this.shadowsLight){this.shadowsLight.direction=new a.Vector3(...e.direction),this.shadowsLight.position=new a.Vector3(...e.position),this.shadowsLight.intensity=e.intensity,this.shadowsLight.diffuse=a.Color3.FromHexString(e.diffuse||"#ffffff"),this.shadowGenerator.mapSize=e.mapSize;return}this.shadowsLight=new a.DirectionalLight("shadowsLight",new a.Vector3(...e.direction),this.scene),this.shadowsLight.intensity=e.intensity||.6,this.shadowsLight.diffuse=a.Color3.FromHexString(e.diffuse||"#ffffff"),this.shadowsLight.position=new a.Vector3(...e.position),this.shadowGenerator=new a.ShadowGenerator(e.mapSize,this.shadowsLight)}else this.shadowsLight&&(this.shadowsLight.dispose(),this.shadowsLight=null)}updateCamera(e){const o=this.scene.activeCamera;o&&(e.radius&&(o.radius=e.radius),o.beta=a.Tools.ToRadians(e.beta),o.alpha=a.Tools.ToRadians(e.alpha),o.useAutoRotationBehavior=e.autoRotation,o.wheelDeltaPercentage=e.wheelDeltaPercentage||.01,o.panningSensibility=1/(e.panningSensibility||.01),o.lowerRadiusLimit=e.lowerRadiusLimit,o.upperRadiusLimit=e.upperRadiusLimit,o.lowerBetaLimit=0,o.upperBetaLimit=Math.PI/2.1)}updateDefaultEnvironment(e){this.environmentHelper&&this.environmentHelper.dispose(),this.environmentHelper=this.scene.createDefaultEnvironment({createGround:e.createGround,groundColor:a.Color3.FromHexString(e.groundColor||"#ffffff"),groundSize:e.groundSize||15,groundOpacity:e.groundOpacity||1,enableGroundShadow:e.enableGroundShadow,groundShadowLevel:e.groundShadowLevel||.5,enableGroundMirror:e.enableGroundMirror===void 0?!0:e.enableGroundMirror,groundMirrorSizeRatio:e.groundMirrorSizeRatio||.3,groundMirrorBlurKernel:e.groundMirrorBlurKernel||64,groundMirrorAmount:e.groundMirrorAmount||1,groundMirrorFresnelWeight:e.groundMirrorFresnelWeight||1,groundYBias:e.groundYBias||0,createSkybox:e.createSkybox,skyboxSize:e.skyboxSize||20,...e.skyboxTexture?{skyboxTexture:e.skyboxTexture}:{},sizeAuto:!0,...e.environmentTexture?{environmentTexture:e.environmentTexture}:{},cameraExposure:e.cameraExposure||.6,cameraContrast:e.cameraContrast||1.6}),this.environmentHelper.ground&&(this.environmentHelper.ground.position.y+=.01)}updateMeshs(e){e.meshes.forEach(o=>setTimeout(()=>o.dispose())),a.SceneLoader.ImportMeshAsync("",this.option.meshs.url,"",e,o=>{b.value=(o.loaded/o.total*100).toFixed(2)}).then(o=>{const d=o.meshes;if(this.option.animationGroups=e.animationGroups.map(u=>({uniqueId:u.uniqueId,name:u.name})),this.events&&(this.events.function[0].args[0].select=e.animationGroups.map(u=>({name:u.name,value:u.name}))),this.option.defaultAnimation&&this.option.defaultAnimation.name?this.playAnimation(this.option.defaultAnimation.name,{loop:this.option.defaultAnimation.loop,speedRatio:this.option.defaultAnimation.speedRatio}):e.animationGroups&&e.animationGroups[0]&&e.animationGroups[0].stop(),this.updateShadowsLight(this.option.shadow),e.createDefaultCamera(!0,!0,!0),this.updateCamera(this.option.camera),this.updateScenePipeline(this.option.pipelineOption),this.updateDefaultEnvironment(this.option.environment),this.option.meshs.isCasterShadow&&this.shadowGenerator){this.shadowGenerator.addShadowCaster(e.meshes[0],!0);for(let u=0;u<d.length;u++)d[u].receiveShadows=!1}d[0].position=new a.Vector3(...this.option.meshs.position),setTimeout(()=>{this.engine.hideLoadingUI(),S("on-load-success"),A.SHJParseEvent.parseEvents(r.useEvents,"on-load-success")},100)})}run(){return this.engine.runRenderLoop(()=>{this.scene.render()}),this}dispose(){this.scene&&this.engine&&(this.scene.dispose(),this.engine.dispose())}playAnimation(e,o={loop:!1,speedRatio:1}){if(this.scene){this.scene.stopAllAnimations();const d=this.scene.getAnimationGroupByName(e);d&&(S("on-play-animation"),A.SHJParseEvent.parseEvents(r.useEvents,"on-play-animation"),d.start(o.loop,o.speedRatio,d.from,d.to,!1))}}}const p=i.ref();return i.onMounted(()=>{t.meshs&&(p.value=new E(g.value,t,n).run(),M.useResizeObserver(g.value,P=>{p.value&&p.value.engine.resize()}))}),i.onBeforeUnmount(()=>{p.value&&p.value.dispose()}),{canvasRef:g,babylon:p,Babylon:E,babylonLoadingStatus:w,babylonLoadingTitle:b}},{canvasRef:v,babylon:s,Babylon:y,babylonLoadingStatus:L,babylonLoadingTitle:x}=C(r.basicOption,r.basicEvents);return h({playAnimation:(t,n)=>{const g=t[0].value,b={loop:t[1].keys[0].defaultValue,speedRatio:t[1].keys[1].defaultValue};s.value.playAnimation(g,b)}}),i.watch(()=>l.cloneDeep(r.basicOption.environment),(t,n)=>{!l.isEqual(t,n)&&s.value&&s.value.updateDefaultEnvironment(t)},{deep:!0}),i.watch(()=>l.cloneDeep(r.basicOption.shadow),(t,n)=>{!l.isEqual(t,n)&&s.value&&s.value.updateShadowsLight(t)},{deep:!0}),i.watch(()=>l.cloneDeep(r.basicOption.camera),(t,n)=>{!l.isEqual(t,n)&&s.value&&s.value.updateCamera(t)},{deep:!0}),i.watch(()=>l.cloneDeep(r.basicOption.meshs),(t,n)=>{!l.isEqual(t,n)&&s.value&&(s.value.dispose(),s.value=new y(v.value,r.basicOption,r.basicEvents).run())},{deep:!0}),i.watch(()=>l.cloneDeep(r.basicOption.defaultAnimation),(t,n)=>{!l.isEqual(t,n)&&s.value&&(s.value.dispose(),s.value=new y(v.value,r.basicOption,r.basicEvents).run())},{deep:!0}),i.watch(()=>l.cloneDeep(r.basicOption.scene),(t,n)=>{!l.isEqual(t,n)&&s.value&&s.value.updateScene(t)},{deep:!0}),i.watch(()=>l.cloneDeep(r.basicOption.pipelineOption),(t,n)=>{!l.isEqual(t,n)&&s.value&&s.value.updateScenePipeline(t)},{deep:!0}),(t,n)=>(i.openBlock(),i.createElementBlock("div",R,[i.createElementVNode("canvas",{ref_key:"canvasRef",ref:v,class:i.normalizeClass(["widget",{show:!i.unref(L)}])},null,2),i.unref(L)?(i.openBlock(),i.createElementBlock("div",{key:0,ref:"babylonLoadingRef",class:"babylon-loading"}," 正在加载模型...("+i.toDisplayString(i.unref(x))+"%) ",513)):i.createCommentVNode("",!0)]))}});exports.default=T;
