"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const r=require("vue");require("@babylonjs/loaders/glTF");const V=require("@babylonjs/core"),s=require("lodash"),P=require("../../commons/plugins/event/index.js");function H(b){const E=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(b){for(const L in b)if(L!=="default"){const e=Object.getOwnPropertyDescriptor(b,L);Object.defineProperty(E,L,e.get?e:{enumerable:!0,get:()=>b[L]})}}return E.default=b,Object.freeze(E)}const t=H(V),I={class:"zerov-widget"},Z=r.defineComponent({name:"zv-commons-three-loader3"}),j=r.defineComponent({...Z,props:{basicOption:{},basicEvents:{},useEvents:{}},emits:["on-load-success","on-play-animation"],setup(b,{expose:E,emit:L}){const e=b,A=L;let y,o,c,h,f,d,v,g,u,O,l,a;const B=()=>{c||(c=new t.ArcRotateCamera("Camera",e.basicOption.camera.alpha,e.basicOption.camera.beta,e.basicOption.camera.radius,new t.Vector3(e.basicOption.camera.target[0],e.basicOption.camera.target[1],e.basicOption.camera.target[2]),o)),c.alpha=e.basicOption.camera.alpha,c.beta=e.basicOption.camera.beta,c.radius=e.basicOption.camera.radius,c.target=new t.Vector3(e.basicOption.camera.target[0],e.basicOption.camera.target[1],e.basicOption.camera.target[2]),c.lowerRadiusLimit=e.basicOption.camera.lowerRadiusLimit,c.upperRadiusLimit=e.basicOption.camera.upperRadiusLimit,c.lowerBetaLimit=t.Tools.ToRadians(e.basicOption.camera.lowerBetaLimit),c.upperBetaLimit=t.Tools.ToRadians(e.basicOption.camera.upperBetaLimit),c.useBouncingBehavior=e.basicOption.camera.useBouncingBehavior,c.wheelDeltaPercentage=e.basicOption.camera.wheelDeltaPercentage||.01,c.useAutoRotationBehavior=e.basicOption.camera.autoRotation,c.panningSensibility=1/(e.basicOption.camera.panningSensibility||.01),c.attachControl(C.value,!0)},D=()=>{o||(o=new t.Scene(y)),o.environmentTexture=t.CubeTexture.CreateFromPrefilteredData(e.basicOption.scene.environmentTexture,o),o.environmentIntensity=e.basicOption.scene.environmentIntensity,e.basicOption.scene.colorShow?o.clearColor=t.Color4.FromHexString(e.basicOption.scene.color||"#000000"):o.clearColor=new t.Color4(0,0,0,0),o.fogEnabled=e.basicOption.scene.fogEnabled,o.fogMode=e.basicOption.scene.fogMode||1,o.fogColor=t.Color3.FromHexString(e.basicOption.scene.fogColor||"#ffffff"),o.fogEnd=e.basicOption.scene.fogEnd||2e3,o.fogStart=e.basicOption.scene.fogStart||1,o.fogDensity=e.basicOption.scene.fogDensity*1e-4},F=()=>{if(h||(h=new t.DirectionalLight("dirLight",new t.Vector3(e.basicOption.directionalLight.direction[0],e.basicOption.directionalLight.direction[1],e.basicOption.directionalLight.direction[2]),o)),h.direction=new t.Vector3(e.basicOption.directionalLight.direction[0],e.basicOption.directionalLight.direction[1],e.basicOption.directionalLight.direction[2]),h.position=new t.Vector3(e.basicOption.directionalLight.position[0],e.basicOption.directionalLight.position[1],e.basicOption.directionalLight.position[2]),h.diffuse=t.Color3.FromHexString(e.basicOption.directionalLight.diffuse||"#ffffff"),h.intensity=e.basicOption.directionalLight.intensity,h.shadowMinZ=e.basicOption.directionalLight.shadowMinZ,h.shadowMaxZ=e.basicOption.directionalLight.shadowMaxZ,h.autoCalcShadowZBounds=e.basicOption.directionalLight.autoCalcShadowZBounds,e.basicOption.directionalLight.shadowGenerator.enable){const{mapSize:i,transparencyShadow:n,usePercentageCloserFiltering:p,bias:m}=e.basicOption.directionalLight.shadowGenerator;if(!d&&(d=new t.ShadowGenerator(i,h),l))for(let w=0;w<l.length;w++)e.basicOption.meshes.isCasterShadow&&d&&d.addShadowCaster(l[w],!0);d.mapSize=i,d.transparencyShadow=n,d.usePercentageCloserFiltering=p,d.bias=m}else d&&(d.dispose(),d=null);e.basicOption.directionalLight.lightGizmo&&e.basicOption.directionalLight.lightGizmo.enable?(f||(f=new t.LightGizmo,f.light=h),f.scaleRatio=e.basicOption.directionalLight.lightGizmo.scaleRatio):f&&(f.dispose(),f=null)},R=()=>{v||(v=new t.HemisphericLight("light",new t.Vector3(e.basicOption.hemisphericLight.direction[0],e.basicOption.hemisphericLight.direction[1],e.basicOption.hemisphericLight.direction[2]),o)),v.direction=new t.Vector3(e.basicOption.hemisphericLight.direction[0],e.basicOption.hemisphericLight.direction[1],e.basicOption.hemisphericLight.direction[2]),v.intensity=e.basicOption.hemisphericLight.intensity,v.diffuse=t.Color3.FromHexString(e.basicOption.hemisphericLight.diffuse||"#ffffff"),e.basicOption.hemisphericLight.lightGizmo&&e.basicOption.hemisphericLight.lightGizmo.enable?(g||(g=new t.LightGizmo,g.light=v),g.scaleRatio=e.basicOption.hemisphericLight.lightGizmo.scaleRatio):g&&(g.dispose(),g=null)},G=()=>{if(e.basicOption.ground.enable){const{width:i,height:n,position:p,rotation:m,scaling:w,material:S,receiveShadows:q}=e.basicOption.ground;u||(u=t.MeshBuilder.CreateGround("ground",{width:i,height:n},o)),u.position=new t.Vector3(p[0],p[1],p[2]),u.rotation=new t.Vector3(t.Tools.ToRadians(m[0]),t.Tools.ToRadians(m[1]),t.Tools.ToRadians(m[2])),u.scaling=new t.Vector3(w[0],w[1],w[2]);const x=new t.StandardMaterial("",o);x.emissiveTexture=new t.Texture(S.emissiveTexture,o),x.diffuseTexture=new t.Texture(S.emissiveTexture,o),x.ambientTexture=new t.Texture(S.emissiveTexture,o),x.diffuseColor=new t.Color3(1,1,1),x.opacityTexture=new t.Texture(S.opacityTexture,o),u.material=x,u.receiveShadows=q}else u&&(u.dispose(),u=null)},M=()=>{if(e.basicOption.skybox.enable){const{size:i}=e.basicOption.skybox;O||(O=t.MeshBuilder.CreateBox("skyBox",{size:i},o));const n=new t.StandardMaterial("skyBox",o);n.backFaceCulling=!1,n.reflectionTexture=t.CubeTexture.CreateFromPrefilteredData(e.basicOption.scene.environmentTexture,o),n.reflectionTexture.coordinatesMode=t.Texture.SKYBOX_MODE,n.diffuseColor=new t.Color3(1,1,1),n.specularColor=new t.Color3(1,1,1),n.disableLighting=!0,O.material=n,O.isPickable=!1}else O&&(O.dispose(),O=null)},k=(i,n={loop:!1,speedRatio:1})=>{if(o){o.stopAllAnimations();const p=o.getAnimationGroupByName(i);p&&(A("on-play-animation"),P.SHJParseEvent.parseEvents(e.useEvents,"on-play-animation"),p.start(n.loop,n.speedRatio,p.from,p.to,!1))}},T=async()=>{l||(l=(await t.SceneLoader.ImportMeshAsync("",e.basicOption.meshes.url,"",o)).meshes),l[0].position=new t.Vector3(e.basicOption.meshes.position[0],e.basicOption.meshes.position[1],e.basicOption.meshes.position[2]),l[0].scaling=new t.Vector3(e.basicOption.meshes.scaling[0],e.basicOption.meshes.scaling[1],e.basicOption.meshes.scaling[2]),l[0].rotation=new t.Vector3(t.Tools.ToRadians(e.basicOption.meshes.rotation[0]),t.Tools.ToRadians(e.basicOption.meshes.rotation[1]),t.Tools.ToRadians(e.basicOption.meshes.rotation[2]));for(let i=0;i<l.length;i++)l[i].isPickable=!1,l[i].receiveShadows=e.basicOption.meshes.isCasterShadow,e.basicOption.meshes.isCasterShadow&&d&&d.addShadowCaster(l[i],!0);e.basicOption.animationGroups=o.animationGroups.map(i=>({uniqueId:i.uniqueId,name:i.name})),e.basicEvents&&(e.basicEvents.function[0].args[0].select=o.animationGroups.map(i=>({name:i.name,value:i.name}))),e.basicOption.defaultAnimation&&e.basicOption.defaultAnimation.name?k(e.basicOption.defaultAnimation.name,{loop:e.basicOption.defaultAnimation.loop,speedRatio:e.basicOption.defaultAnimation.speedRatio}):o.animationGroups&&o.animationGroups[0]&&o.animationGroups[0].stop()},z=()=>{const i=e.basicOption.pipelineOption;i&&i.enabled?(a||(a=new t.DefaultRenderingPipeline("defaultPipeline",!0,o,[c])),a.samples=i.samples?4:1,a.fxaaEnabled=i.fxaaEnabled,a.grainEnabled=i.grainEnabled,a.grain.intensity=i.grainIntensity,a.grain.animated=i.grainAnimated,a.bloomEnabled=i.bloomEnabled,a.bloomThreshold=i.bloomThreshold,a.bloomWeight=i.bloomWeight,a.bloomKernel=i.bloomKernel,a.bloomScale=i.bloomScale,a.depthOfFieldEnabled=i.depthOfFieldEnabled,i.depthOfFieldBlurLevel<1?a.depthOfFieldBlurLevel=t.DepthOfFieldEffectBlurLevel.Low:i.depthOfFieldBlurLevel<2?a.depthOfFieldBlurLevel=t.DepthOfFieldEffectBlurLevel.Medium:i.depthOfFieldBlurLevel<3&&(a.depthOfFieldBlurLevel=t.DepthOfFieldEffectBlurLevel.High),a.depthOfField.focusDistance=i.depthOfFieldFocusDistance,a.depthOfField.fStop=i.depthOfFieldFStop,a.depthOfField.focalLength=i.depthOfFieldFocalLength,a.chromaticAberrationEnabled=i.chromaticAberrationEnabled,a.chromaticAberration.aberrationAmount=i.chromaticAberrationAberrationAmount,a.chromaticAberration.radialIntensity=i.chromaticAberrationRadialIntensity,i.chromaticAberrationDirection===0?(a.chromaticAberration.direction.x=0,a.chromaticAberration.direction.y=0):(a.chromaticAberration.direction.x=Math.sin(i.chromaticAberrationDirection),a.chromaticAberration.direction.y=Math.cos(i.chromaticAberrationDirection)),a.sharpenEnabled=i.sharpenEnabled,a.sharpen.edgeAmount=i.sharpenEdgeAmount,a.sharpen.colorAmount=i.sharpenColorAmount):a&&(a.dispose(),a=null)},_=function(i){D(),B(),R(),F(),G(),M(),T(),z(),A("on-load-success"),P.SHJParseEvent.parseEvents(e.useEvents,"on-load-success")},C=r.ref();return r.onMounted(()=>{y=new t.Engine(C.value,!0),y&&e.basicOption.meshes.url&&(_(),y.runRenderLoop(function(){o&&o.render()}))}),r.onBeforeUnmount(()=>{o.dispose(),y.dispose()}),E({playAnimation:(i,n)=>{const p=i[0].value,m={loop:i[1].keys[0].defaultValue,speedRatio:i[1].keys[1].defaultValue};k(p,m)}}),r.watch(()=>s.cloneDeep(e.basicOption.camera),(i,n)=>{!s.isEqual(i,n)&&c&&B()},{deep:!0}),r.watch(()=>s.cloneDeep(e.basicOption.scene),(i,n)=>{!s.isEqual(i,n)&&o&&D()},{deep:!0}),r.watch(()=>s.cloneDeep(e.basicOption.directionalLight),(i,n)=>{s.isEqual(i,n)||F()},{deep:!0}),r.watch(()=>s.cloneDeep(e.basicOption.hemisphericLight),(i,n)=>{s.isEqual(i,n)||R()},{deep:!0}),r.watch(()=>s.cloneDeep(e.basicOption.ground),(i,n)=>{s.isEqual(i,n)||G()},{deep:!0}),r.watch(()=>s.cloneDeep(e.basicOption.skybox),(i,n)=>{s.isEqual(i,n)||M()},{deep:!0}),r.watch(()=>s.cloneDeep(e.basicOption.meshes),(i,n)=>{!s.isEqual(i,n)&&l&&i.url===n.url&&T()},{deep:!0}),r.watch(()=>s.cloneDeep(e.basicOption.meshes.url),(i,n)=>{s.isEqual(i,n)||(o.meshes.forEach((p,m)=>{m>1&&p.dispose()}),l=null,T())},{deep:!0}),r.watch(()=>s.cloneDeep(e.basicOption.pipelineOption),(i,n)=>{s.isEqual(i,n)||z()},{deep:!0}),(i,n)=>(r.openBlock(),r.createElementBlock("div",I,[r.createElementVNode("canvas",{ref_key:"canvasRef",ref:C,class:r.normalizeClass(["widget",{show:!0}])},null,512)]))}});exports.default=j;
