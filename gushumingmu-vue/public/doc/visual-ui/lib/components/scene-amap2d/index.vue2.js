"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const n=require("vue"),U=require("@amap/amap-jsapi-loader"),$=require("axios"),K=require("nanoid"),Q=require("../../commons/plugins/datasource/index.js"),y=require("../../commons/plugins/event/index.js"),X=m=>(n.pushScopeId("data-v-1a9e6290"),m=m(),n.popScopeId(),m),Y=X(()=>n.createElementVNode("div",{id:"zerov-amap-2d",class:"zerov-amap-container"},null,-1)),ee=[Y],ae=n.defineComponent({name:"zv-scene-amap2d"}),te=n.defineComponent({...ae,props:{basicOption:{},sources:{},useEvents:{},uuid:{}},emits:["amap2d-scene-success","amap2d-scene-zoomstart","amap2d-scene-zoomend","amap2d-scene-mapclick","amap2d-scene-dragstart","amap2d-scene-dragging","amap2d-scene-dragend"],setup(m,{expose:E,emit:L}){const r=m,p=L;y.SHJParseEvent.parseEvents(r.useEvents,"on-page-loaded",null);const M=()=>{const o=n.shallowRef(),i=n.shallowRef(),z=n.ref(!1),f=n.ref(),v=n.ref(),b=n.ref(),u=n.ref(),k=a=>{O(),window._AMapSecurityConfig={securityJsCode:a.basic.securityJsCode},U.load({key:a.basic.key,version:"2.0",Loca:{version:"2.0.0"},plugins:["AMap.ControlBar","AMap.ToolBar","AMap.Scale","AMap.HeatMap","AMap.GeoJSON","AMap.ImageLayer","AMap.TileLayer"]}).then(e=>{u.value=e;const s=new u.value.createDefaultLayer({visible:!0,opacity:1,zIndex:0});o.value=new e.Map("zerov-amap-2d",{rotateEnable:a.config.rotateEnable,pitchEnable:a.config.pitchEnable,zoomEnable:a.config.zoomEnable,dragEnable:a.config.dragEnable,zoom:a.config.zoom,viewMode:"2D",zooms:a.config.zooms,center:a.config.center,mapStyle:a.config.mapStyle,features:a.config.features,layers:[s]}),i.value=new window.Loca.Container({map:o.value}),b.value=new u.value.Scale({visible:a.config.plugin.scale.visible,position:{left:a.config.plugin.scale.position.left+"px",bottom:a.config.plugin.scale.position.bottom+"px"}}),o.value.addControl(b.value),f.value=new e.ControlBar({visible:a.config.plugin.controlBar.visible,showControlButton:a.config.plugin.controlBar.showControlButton,position:{right:a.config.plugin.controlBar.position.right+"px",top:a.config.plugin.controlBar.position.top+"px"}}),o.value.addControl(f.value),v.value=new e.ToolBar({visible:a.config.plugin.toolBar.visible,position:{left:a.config.plugin.toolBar.position.left+"px",top:a.config.plugin.toolBar.position.top+"px"}}),o.value.addControl(v.value),C(e),o.value.on("complete",()=>{setTimeout(()=>{z.value=!0,p("amap2d-scene-success"),y.SHJParseEvent.parseEvents(r.useEvents,"amap2d-scene-success",null)},666)}),o.value.on("zoomstart",()=>{p("amap2d-scene-zoomstart"),y.SHJParseEvent.parseEvents(r.useEvents,"amap2d-scene-zoomstart",null)}),o.value.on("zoomend",()=>{p("amap2d-scene-zoomend"),y.SHJParseEvent.parseEvents(r.useEvents,"amap2d-scene-zoomend",null)}),o.value.on("click",t=>{p("amap2d-scene-mapclick",t.lnglat),y.SHJParseEvent.parseEvents(r.useEvents,"amap2d-scene-mapclick",t.lnglat)}),o.value.on("dragstart",t=>{p("amap2d-scene-dragstart",t.lnglat),y.SHJParseEvent.parseEvents(r.useEvents,"amap2d-scene-dragstart",t.lnglat)}),o.value.on("dragend",t=>{p("amap2d-scene-dragend",t.lnglat),y.SHJParseEvent.parseEvents(r.useEvents,"amap2d-scene-dragend",t.lnglat)})}).catch(e=>{})},C=a=>{r.sources&&r.sources.length>0?Q.SHJDatasourceV2.parse({tId:r.uuid,sources:r.sources,callback:s=>{try{const t=r.basicOption.widgets.find(l=>l._sourceId===s.id);t&&t.type==="heatmap"&&D(a,t,s.data[0].data),t&&t.type==="dotlayers"&&H(window.Loca,t,w(s.data[0].data)),t&&t.type==="scatter"&&N(window.Loca,t,w(s.data[0].data)),t&&t.type==="labelsLayer"&&q(window.Loca,t,w(s.data[0].data))}catch{}r.basicOption.widgets.filter(t=>t.type==="boundary").forEach(t=>{x(a,t)})}}):r.basicOption.widgets.filter(s=>s.type==="boundary").forEach(s=>{x(a,s)});const e=o.value.getLayers();for(let s=0;s<e.length;s++)(e[s].type==="sketchTileLayer"||e[s]._opts.type==="sketchImageLayer")&&o.value.removeLayer(e[s]);r.basicOption.widgets.filter(s=>s.type==="sketchTile").forEach(s=>{const t=J(s);t&&o.value.addLayer(t)}),r.basicOption.widgets.filter(s=>s.type==="sketchImage").forEach(s=>{const t=T(s);o.value.addLayer(t)})},P=a=>{const s=a.slice(a.indexOf("(")+1,a.lastIndexOf(")")).split(",").map(l=>l.trim()),t={};for(let l=1;l<s.length;l++){const d=s[l].split(" "),c=d[0],h=parseFloat(d[1])/100,V=Math.round(h*100)/100;t[V]=c}return t},J=a=>{try{return new u.value.TileLayer({bounds:new u.value.Bounds(a.bounds[0],a.bounds[1]),getTileUrl:function(s,t,l){try{return a.url.replace("{z}",l).replace("{x}",s).replace("{y}",t)}catch{}},type:"sketchTileLayer",tileSize:a.tileSize,opacity:a.opacity,zIndex:a.zIndex,zooms:a.zooms})}catch{}return null},T=a=>{try{return new u.value.ImageLayer({bounds:new u.value.Bounds(a.bounds[0],a.bounds[1]),type:"sketchImageLayer",opacity:a.opacity,url:a.url,zIndex:a.zIndex,zooms:a.zooms})}catch{}return null},D=(a,e,s)=>{try{const t=new a.HeatMap(o.value,{radius:e.radius,opacity:e.opacity,gradient:P(e.gradient)});setTimeout(()=>{t.setDataSet({data:s,max:e.max})},0)}catch{}},x=async(a,e)=>{try{const s=await $.get(e.geojson);if(s.status===200){const t=new a.GeoJSON({geoJSON:s.data,getPolygon:function(l,d){const c=new a.Polygon({path:d,zIndex:e.zIndex,fillColor:e.style.fillColor,strokeOpacity:e.style.strokeOpacity,fillOpacity:e.style.fillOpacity,strokeColor:e.style.strokeColor,strokeWeight:e.style.strokeWeight,strokeStyle:e.style.strokeStyle});return c.on("mouseover",()=>{c.setOptions({fillOpacity:e.mouseover.fillOpacity,fillColor:e.mouseover.fillColor,strokeOpacity:e.mouseover.strokeOpacity,strokeColor:e.mouseover.strokeColor,strokeStyle:e.mouseover.strokeStyle,strokeWeight:e.mouseover.strokeWeight})}),c.on("mouseout",()=>{c.setOptions({fillColor:e.style.fillColor,strokeOpacity:e.style.strokeOpacity,fillOpacity:e.style.fillOpacity,strokeColor:e.style.strokeColor,strokeWeight:e.style.strokeWeight,strokeStyle:e.style.strokeStyle})}),c}});o.value.add(t)}}catch{}},H=(a,e,s)=>{try{const t=new a.GeoJSONSource({data:s}),l=new a.PointLayer({zIndex:e.zIndex,blend:e.blend,visible:e.visible,opacity:e.opacity}),d={radius:e.style.radius,unit:e.style.unit,color:e.style.color,borderWidth:e.style.borderWidth,blurWidth:e.style.blurWidth,borderColor:e.style.borderColor};l.setSource(t),l.setStyle(d),i.value.add(l),l.addAnimate({key:e.animate.key,value:e.animate.value,duration:e.animate.duration,easing:e.animate.easing,transform:e.animate.transform,random:e.animate.random,delay:e.animate.delay,yoyo:e.animate.yoyo,repeat:e.animate.repeat})}catch{}},N=(a,e,s)=>{try{const t=new a.GeoJSONSource({data:s}),l=new a.ScatterLayer({loca:i.value,zIndex:e.zIndex,opacity:e.opacity,visible:e.visible,zooms:e.zooms});l.setSource(t),l.setStyle({unit:e.style.unit,size:e.style.size,borderWidth:e.style.borderWidth,texture:e.style.texture,duration:e.style.duration,animate:e.style.animate}),i.value.animate.start()}catch{}},q=(a,e,s)=>{try{const t=new a.GeoJSONSource({data:s}),l=new a.LabelsLayer({eventSupport:!0,visible:e.visible,zooms:e.zooms,opacity:e.opacity,collision:e.collision,allowCollision:e.allowCollision,zIndex:e.zIndex});l.setSource(t),l.setStyle({icon:{image:e.icon.image,size:e.icon.size,clipOrigin:e.icon.clipOrigin,offset:e.icon.offset,anchor:e.icon.anchor},text:{content:(d,c)=>c.properties[e.text.content],zooms:e.text.zooms,offset:e.text.offset,direction:e.text.direction,style:{fontSize:e.text.style.fontSize,fillColor:e.text.style.fillColor,strokeColor:e.text.style.strokeColor,strokeWidth:e.text.style.strokeWidth,padding:e.text.style.padding,backgroundColor:e.text.style.backgroundColor,borderColor:e.text.style.borderColor,borderWidth:e.text.style.borderWidth,fold:e.text.style.fold,fontWeight:e.text.style.fontWeight}}}),l.on("complete",()=>{const d=l.getLabelsLayer().getAllOverlays();for(const c of d)c.on("click",h=>{}),c.on("mouseover",h=>{}),c.on("mouseout",h=>{})}),i.value.add(l)}catch{}},w=a=>{const e={type:"FeatureCollection",features:[]};return a.forEach((s,t)=>{const l={type:"Feature",id:K.nanoid(),properties:{name:s.name||"",_draw_type:"point"},geometry:{type:"Point",coordinates:s.value}};e.features.push(l)}),e},F=a=>{o.value.setFeatures(a.config.features),o.value.setStatus({dragEnable:a.config.dragEnable,zoomEnable:a.config.zoomEnable,rotateEnable:a.config.rotateEnable}),a.config.plugin.scale.visible?b.value.show():b.value.hide(),a.config.plugin.toolBar.visible?v.value.show():v.value.hide(),a.config.plugin.controlBar.visible?f.value.show():f.value.hide()},G=()=>{o.value.clearMap(),i.value.clear(),C(u.value)},j=a=>{o.value.setMapStyle(a.config.mapStyle)},R=a=>{o.value.setZoom(a.config.zoom,!1,200)},Z=a=>{o.value.setCenter(a.config.center,!1,200)},O=()=>{o.value&&(o.value.clearMap(),o.value.destroy(),o.value=null,i.value&&(i.value.clear(),i.value.destroy(),i.value=null))};return n.onMounted(()=>{setTimeout(()=>{k(r.basicOption)},0)}),n.onUnmounted(()=>O()),{initAMap2d:k,updateAMapStyle:j,updateAMapConfig:F,updateAMapComponents:G,updateAMapZoom:R,updateAMapCenter:Z,amap2d:o,loading:z,AMapPrototype:u}},{initAMap2d:g,updateAMapStyle:I,updateAMapConfig:S,updateAMapComponents:A,updateAMapZoom:B,updateAMapCenter:_,loading:W}=M();return n.watch(()=>r.basicOption.config,()=>{S(r.basicOption)},{deep:!0}),n.watch(()=>r.basicOption.config.zoom,()=>{B(r.basicOption)},{deep:!0}),n.watch(()=>r.basicOption.config.center,()=>{_(r.basicOption)},{deep:!0}),n.watch(()=>r.basicOption.widgets,()=>{A()},{deep:!0}),n.watch(()=>r.basicOption.config.mapStyle,()=>{I(r.basicOption)},{deep:!0}),n.watch(()=>r.basicOption.basic,()=>{g(r.basicOption)},{deep:!0}),n.watch(()=>r.sources,()=>{g(r.basicOption)},{deep:!0}),E({refresh:()=>g(r.basicOption),refreshView:()=>S(r.basicOption),refreshData:()=>g(r.basicOption)}),(o,i)=>(n.openBlock(),n.createElementBlock("div",{class:n.normalizeClass(["amap-2d-wrap",{show:n.unref(W)}])},ee,2))}});exports.default=te;
