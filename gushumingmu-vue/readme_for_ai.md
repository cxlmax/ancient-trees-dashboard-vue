# 古树名木智慧监测系统 - 技术文档

## 项目概述

古树名木智慧监测系统是一个基于 Vue.js 的可视化监测平台，用于展示和监控古树名木的状态信息。系统集成了地图展示、实时数据监控、警报系统等功能。

## 系统架构

### 前端框架

- **Vue.js**: 项目基于 Vue.js 构建，利用其响应式系统管理 UI 和数据状态
- **Pinia**: 用于状态管理
- **Axios**: 用于处理 HTTP 请求

### 关键组件

#### @shjjs/visual-ui 地图组件

系统使用 `@shjjs/visual-ui` 提供的 `zv-scene-map3d` 组件实现地图可视化，这是一个基于 Three.js 的 3D 地图组件。

**地图渲染机制**:

1. 数据源通过 `sources` 属性传入组件
2. 地图配置通过 `basic-option` 属性控制
3. 事件处理通过 `use-events` 属性定义，组件支持 `on-drill-down` 和 `on-return` 等事件

**数据更新机制**:

1. 由于组件使用的数据结构复杂且嵌套层级深，直接修改内部属性可能不会触发 Vue 的响应式更新
2. 正确的更新方式是创建数据的完整深拷贝，修改后替换整个引用，确保 Vue 能检测到变化
3. 使用 `JSON.parse(JSON.stringify())` 进行深拷贝，然后通过 `sceneSources.value = newSources` 完全替换引用

#### 警报监控系统

系统通过 `WarningMonitor.js` 服务监控警报状态：

1. 定期向 `/api/iswarning` 接口发送请求
2. 当检测到警报状态变化时，触发回调函数
3. 支持注册多个回调函数，进行不同模块的警报响应

#### 布局系统

1. 地球标签组件(mEarthLabel)使用绝对定位，需要设置明确的固定尺寸和位置
2. 在嵌套结构中需注意层级关系，合理设置 z-index 确保显示正确

## 功能模块

### 地图警报功能

当系统触发警报时：

1. 湖南省和长沙市的值会被修改为 5555
2. 地图会显示红色预警效果
3. 警报按钮会显示在界面上（通过 `App.vue` 中的 `showAlarmButton` 控制）

**关键代码**:

- 警报状态变化处理在 `scene.vue` 的 `handleWarningChange` 函数中
- 警报触发和取消时需使用深拷贝确保数据更新被正确检测

### 地图下钻功能

地图支持下钻交互：

1. 点击省份可下钻到市级地图
2. 可以通过返回按钮回到上级地图
3. 下钻和返回事件通过 `handleMapDrilling` 和 `handleMapBack` 函数处理

## API 接口

- `/api/iswarning`: 获取系统警报状态
- 其他数据接口根据具体功能模块定义

## 常见问题处理

1. **地图数据更新后未渲染**：确保使用深拷贝创建新数据对象，并完全替换引用
2. **组件布局异常**：检查组件的定位方式，对于绝对定位的组件，确保设置了正确的尺寸和位置
